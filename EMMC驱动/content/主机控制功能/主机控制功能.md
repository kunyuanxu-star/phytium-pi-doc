<cite>
**本文档中引用的文件**
- [mci_timing.rs](file://src/mci/mci_timing.rs)
- [mci_config.rs](file://src/mci/mci_config.rs)
- [mci_host_config.rs](file://src/mci_host/mci_host_config.rs)
- [consts.rs](file://src/mci/consts.rs)
- [consts.rs](file://src/mci_host/sd/consts.rs)
</cite>

## 目录
1. [主机控制功能](#主机控制功能)
2. [时钟配置与频率计算](#时钟配置与频率计算)
3. [电压切换与操作状态管理](#电压切换与操作状态管理)
4. [总线宽度配置](#总线宽度配置)
5. [初始化流程示例](#初始化流程示例)

## 主机控制功能

本文档详细阐述了Phytium MCI驱动中主机控制功能的实现，涵盖时钟配置、电压切换和总线宽度设置等核心机制。系统通过`mci_timing.rs`、`mci_config.rs`和`mci_host_config.rs`三个核心模块协同工作，实现对SD卡从识别到高速数据传输的完整生命周期管理。

**Section sources**
- [mci_timing.rs](file://src/mci/mci_timing.rs#L1-L182)
- [mci_config.rs](file://src/mci/mci_config.rs#L1-L91)
- [mci_host_config.rs](file://src/mci_host/mci_host_config.rs#L1-L83)

## 时钟配置与频率计算

时钟配置是MCI主机初始化和操作的核心环节，主要由`mci_timing.rs`文件中的`MCITiming`结构体和预定义常量实现。系统根据SD卡规范，通过预计算的分频系数和时钟源参数来精确设置时钟频率。

### 时钟频率常量与分频

系统在`mci_timing.rs`中定义了多个预计算的时钟配置常量，这些常量直接对应SD卡规范中的标准工作频率。例如，`MMC_SD_400K_HZ`常量用于初始化阶段的低速识别模式，其`clk_div`（时钟分频）和`clk_src`（时钟源）字段被设置为特定的十六进制值，以确保输出频率稳定在400KHz。对于高速模式，如`SD_50MHZ`和`MMC_52MHZ`，系统同样提供了对应的常量，这些常量的分频系数经过精确计算，以匹配外部晶振频率并生成目标工作频率。

### 时钟稳定性与IO延时调整

为了确保高速时钟下的信号完整性，系统实现了IO管脚延时调整机制。`MCITiming`结构体中的`pad_delay`字段（类型为`MCIPadDelay`）用于控制是否应用延时。当配置为`MCIPadDelay::Set`时，系统会调用`set_pad_delay`函数，通过`apply_delay_settings`为特定的MCI控制器（如MCI0或MCI1）设置粗调和细调延时。该机制通过配置`Fsdif0SdCclkOutDelay`或`Fsdif1SdCclkOutDelay`寄存器，对时钟输出信号进行相位微调，从而补偿PCB走线延迟，保证时钟与数据信号的同步性。

**Section sources**
- [mci_timing.rs](file://src/mci/mci_timing.rs#L1-L182)
- [consts.rs](file://src/mci/consts.rs#L1-L170)

## 电压切换与操作状态管理

主机对卡的操作电压和识别状态的管理主要在`mci_host_config.rs`中定义。`MCIHostConfig`结构体作为主机配置的核心，包含了`card_clock`字段来存储当前卡的工作时钟频率，以及`is_uhs_card`布尔值来标识卡是否为UHS（Ultra High Speed）类型。

### 操作电压与卡类型

虽然`MCIHostOperationVoltage`枚举未在代码中直接找到，但其功能逻辑体现在`MCIHostConfig`的配置流程中。主机通过`MCIHostCardType`枚举（如`StandardSD`, `MicroSD`, `EMMC`）来区分不同类型的卡，并根据卡类型和特性（如`is_uhs_card`）来决定初始化流程和电压切换策略。例如，UHS卡在初始化后需要执行特定的电压切换命令（如CMD11）来从3.3V切换到1.8V，以支持高速模式。`MCIHostConfig`的`new`方法根据编译时的feature（如`"dma"`或`"pio"`）动态设置`host_id`和`enable_dma`等参数，实现了硬件配置与软件逻辑的解耦。

**Section sources**
- [mci_host_config.rs](file://src/mci_host/mci_host_config.rs#L1-L83)
- [mci_config.rs](file://src/mci/mci_config.rs#L1-L91)

## 总线宽度配置

总线宽度（1-bit, 4-bit, 8-bit）的配置过程主要由`mci_config.rs`中的`MCIConfig`结构体和`mci_host_config.rs`中的`MCIHostConfig`协同完成。

### 配置过程

`MCIConfig`结构体通过`get_tuning`方法根据目标时钟频率（`MCIClkSpeed`）和卡的可移动性（`non_removable`）来查询并返回一个`MCITiming`实例。这个`MCITiming`实例包含了正确的时钟分频和源参数。总线宽度的最终设置是通过向MCI控制器的`FSDIF_CTYPE_OFFSET`寄存器写入特定值来完成的，虽然具体的写寄存器操作在`mci_hardware.rs`中，但`MCIConfig`和`MCIHostConfig`提供了配置决策的逻辑。`MCIHostConfig`中的`def_block_size`字段（默认为`SD_BLOCK_SIZE`，即512字节）也与总线宽度共同决定了数据传输的效率。

**Section sources**
- [mci_config.rs](file://src/mci/mci_config.rs#L1-L91)
- [mci_host_config.rs](file://src/mci_host/mci_host_config.rs#L1-L83)
- [consts.rs](file://src/mci_host/sd/consts.rs#L1-L123)

## 初始化流程示例

以下是一个从低速识别模式切换到高速数据传输模式的完整配置序列示例：

1.  **初始化主机配置**：创建`MCIHostConfig`实例，根据硬件特性设置`host_id`（如`MCI1`）、`enable_dma`为`true`，并将`card_clock`初始化为`SD_CLOCK_50MHZ`。
2.  **配置低速时钟**：调用`MCIConfig::get_tuning(MCIClkSpeed::ClkSpeed400KHz, false)`，获取`MMC_SD_400K_HZ`常量。将此常量中的`clk_div`和`clk_src`值写入`FSDIF_CLKDIV_OFFSET`和`FSDIF_CLK_SRC_OFFSET`寄存器，启动400KHz的时钟。
3.  **卡识别与初始化**：在400KHz时钟下，主机与SD卡进行ACMD41等命令交互，完成卡的识别和初始化。
4.  **电压切换（如适用）**：如果卡支持UHS，执行CMD11命令请求切换到1.8V工作电压。
5.  **配置高速时钟**：卡确认电压切换后，调用`MCIConfig::get_tuning(MCIClkSpeed::ClkSpeed50Mhz, false)`，获取`SD_50MHZ`常量。将新的`clk_div`和`clk_src`值写入寄存器，将时钟频率提升至50MHz。同时，调用`set_pad_delay`函数，为MCI控制器设置IO延时，以保证高速信号的稳定性。
6.  **设置总线宽度**：发送ACMD6命令，请求将数据总线宽度从默认的1-bit切换到4-bit。
7.  **进入高速数据传输模式**：完成上述配置后，主机即可在50MHz、4-bit总线宽度的高速模式下进行数据读写操作。

此流程展示了主机如何通过协调`mci_timing.rs`、`mci_config.rs`和`mci_host_config.rs`中的配置，安全、可靠地完成从识别到高速传输的切换。

**Section sources**
- [mci_timing.rs](file://src/mci/mci_timing.rs#L1-L182)
- [mci_config.rs](file://src/mci/mci_config.rs#L1-L91)
- [mci_host_config.rs](file://src/mci_host/mci_host_config.rs#L1-L83)