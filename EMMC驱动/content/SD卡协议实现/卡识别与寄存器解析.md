<cite>
**Referenced Files in This Document**   
- [cid.rs](file://src/mci_host/sd/cid.rs)
- [csd.rs](file://src/mci_host/sd/csd.rs)
- [scr.rs](file://src/mci_host/sd/scr.rs)
- [mod.rs](file://src/mci_host/sd/mod.rs)
</cite>

# 卡识别与寄存器解析

## Table of Contents
1. [引言](#引言)
2. [CID寄存器解析](#cid寄存器解析)
3. [CSD寄存器解析](#csd寄存器解析)
4. [SCR寄存器解析](#scr寄存器解析)
5. [结构体初始化与数据填充](#结构体初始化与数据填充)

## 引言
在SD卡的识别与初始化过程中，主机需要通过一系列命令读取卡内的关键寄存器，以获取卡的详细信息并配置通信参数。这些寄存器包括CID（Card Identification）、CSD（Card Specific Data）和SCR（SD Configuration Register）。本文档将深入解析`SdCid`、`SdCsd`和`SdScr`三个核心结构体如何对这些寄存器进行解析，阐述其字段提取、参数计算和功能判断的机制。

## CID寄存器解析

`SdCid`结构体用于解析SD卡的CID寄存器，该寄存器包含了卡的制造商和产品信息。结构体定义了制造商ID、OEM应用ID、产品名称、产品版本、序列号和生产日期等字段。

CID寄存器的解析由`SdCard`结构体的`decode_cid`方法完成。该方法从`base.internal_buffer`中读取4个32位的原始数据，并通过位操作提取各个字段。例如，制造商ID（manufacturer_id）是从第一个32位数据的高8位提取的；OEM应用ID（application_id）是从第一个32位数据的第8到23位提取的；产品名称（product_name）是一个5字节的数组，其数据跨越了第一个和第二个32位数据的低24位；序列号（serial_number）则由第二个32位数据的低24位和第三个32位数据的高8位组合而成。

**Section sources**
- [cid.rs](file://src/mci_host/sd/cid.rs#L1-L23)
- [mod.rs](file://src/mci_host/sd/mod.rs#L1950-L1978)

## CSD寄存器解析

`SdCsd`结构体负责解析CSD寄存器，该寄存器包含了卡的容量、读写块大小、擦除块大小等关键操作参数。结构体不仅包含原始字段，还通过`CsdFlags`位标志枚举来表示各种功能特性。

CSD寄存器的解析由`SdCard`结构体的`decode_csd`方法实现。解析过程首先确定CSD结构版本（csd_structure），这决定了后续的解析逻辑。对于版本0（CSD 1.0），容量计算使用`C_SIZE`、`C_SIZE_MULT`和`READ_BL_LEN`字段，计算公式为`block_count = (C_SIZE + 1) << (C_SIZE_MULT + 2)`，然后根据读取块长度调整最终的块大小和块计数。对于版本1（CSD 2.0），容量计算更为简单，直接使用`device_size`字段，`block_count = (device_size + 1) * 1024`，且块大小固定为512字节。

此外，该方法还解析了读写块长度、擦除扇区大小、写保护组大小等参数，并根据位标志设置`flags`字段，以指示卡是否支持部分块读写、错位访问、DSR等特性。

**Section sources**
- [csd.rs](file://src/mci_host/sd/csd.rs#L1-L79)
- [mod.rs](file://src/mci_host/sd/mod.rs#L1980-L2051)

## SCR寄存器解析

`SdScr`结构体用于解析SCR寄存器，该寄存器提供了SD卡的规格版本、支持的命令集和数据宽度等信息，是判断卡功能和配置高速模式的关键。

SCR寄存器的解析由`SdCard`结构体的`decode_scr`方法完成。该方法首先提取SD规格版本（sd_specification），结合`SD_SPECIFICATION3`标志位来判断卡是否支持3.0及以上版本。然后，通过检查`sd_bus_widths`字段来确定卡支持的数据宽度，例如，当该字段的第2位被置位时，表示卡支持4位总线宽度，此时会设置`SdCardFlag::Support4BitWidth`标志。

此外，`command_support`字段用于判断卡是否支持CMD20（速度等级控制）和CMD23（设置块计数）等高级命令。这些信息对于后续的总线宽度设置和性能优化至关重要。

**Section sources**
- [scr.rs](file://src/mci_host/sd/scr.rs#L1-L43)
- [mod.rs](file://src/mci_host/sd/mod.rs#L2052-L2088)

## 结构体初始化与数据填充

`SdCid`、`SdCsd`和`SdScr`结构体均通过`new`方法进行初始化，该方法将所有字段设置为默认值（通常为0），确保结构体在使用前处于一个已知的、安全的状态。

这些结构体的实例化发生在`SdCard`结构体的`from_base`方法中，作为`SdCard`初始化过程的一部分。数据填充则是在SD卡初始化流程中，通过发送特定的SD命令（如CMD2读取CID，CMD9读取CSD，ACMD51读取SCR）后，由相应的`decode_`方法完成。整个流程由`SdCard`的`card_init_proc`方法协调，该方法按顺序执行卡的识别、地址分配、CSD读取、选择、SCR读取等步骤，最终完成所有寄存器的解析和内部状态的配置。

**Section sources**
- [mod.rs](file://src/mci_host/sd/mod.rs#L170-L190)
- [mod.rs](file://src/mci_host/sd/mod.rs#L1800-L1820)
- [mod.rs](file://src/mci_host/sd/mod.rs#L1940-L1946)