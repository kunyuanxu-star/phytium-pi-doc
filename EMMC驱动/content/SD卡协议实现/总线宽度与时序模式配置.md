# 总线宽度与时序模式配置

<cite>
**本文档引用的文件**  
- [data_bus_width_set](file://src/mci_host/sd/mod.rs#L1628-L1673)
- [bus_timing_select](file://src/mci_host/sd/mod.rs#L354-L388)
- [SdIoVoltage](file://src/mci_host/sd/io_voltage.rs#L0-L34)
- [switch_io_voltage](file://src/mci_host/sd/mod.rs#L422-L459)
- [mci_timing.rs](file://src/mci/mci_timing.rs#L0-L182)
- [sdif_device.rs](file://src/mci_host/mci_sdif/sdif_device.rs#L131-L178)
- [consts.rs](file://src/mci_host/sd/consts.rs#L0-L123)
- [constants.rs](file://src/mci_host/constants.rs#L31-L73)
</cite>

## 目录
1. [总线宽度配置](#总线宽度配置)  
2. [时序模式选择](#时序模式选择)  
3. [电压切换控制](#电压切换控制)  
4. [时钟频率与性能](#时钟频率与性能)

## 总线宽度配置

`data_bus_width_set` 函数通过发送 ACMD6 命令实现 SD 卡总线宽度的动态配置。该过程首先通过 `application_cmd_send` 发送应用命令前缀，随后构造一个类型为 `R1` 的响应命令，其命令索引为 `SdAppCmd::SetBusWdith`。当请求设置为 4 位模式时，命令参数被设置为 2；若为 1 位模式，则参数为 0。该操作依赖于 `Support4BitWidth` 标志位，该标志在读取 SCR（SD 配置寄存器）后被设置，用于指示卡是否支持 4 位数据宽度。只有当此标志被置位时，驱动才会尝试执行总线宽度切换，从而确保操作的合法性与稳定性。

**本节来源**  
- [data_bus_width_set](file://src/mci_host/sd/mod.rs#L1628-L1673)
- [SdAppCmd](file://src/mci_host/sd/consts.rs#L46-L78)
- [SdCardFlag](file://src/mci_host/sd/consts.rs#L108-L114)

## 时序模式选择

`bus_timing_select` 函数负责根据卡能力和主机支持情况选择最优的时序模式。若工作电压为 3.3V，则尝试进入高电平速度模式（SDR25）；若为 1.8V，则按优先级依次尝试 SDR104、SDR50 和 SDR25 模式。选择过程通过 `func_select` 调用 CMD6 命令，查询功能组 0（时序模式）下的功能编号。若主机和卡均支持 SDR104，则设置时钟为 208MHz；若仅支持 SDR50，则设为 100MHz。对于 SDR50 和 SDR104 模式，还需执行调谐（tuning）过程以确保信号完整性。

**本节来源**  
- [bus_timing_select](file://src/mci_host/sd/mod.rs#L354-L388)
- [SdTimingMode](file://src/mci_host/sd/consts.rs#L0-L44)
- [SdTimingFuncNum](file://src/mci_host/sd/consts.rs#L66-L78)

## 电压切换控制

`SdIoVoltage` 结构体用于管理 I/O 电压控制方式，其 `typ` 字段指示电压切换由主机（ByHost）或 GPIO（ByGpio）控制。`switch_io_voltage` 函数协调硬件层完成 1.8V 信号切换：若由主机控制，则调用 `switch_to_voltage` 更新硬件寄存器并通知卡进入 UHS-I 模式；若由 GPIO 控制，则调用用户注册的回调函数。电压切换前需确认卡支持 1.8V 并启用 SDR50/SDR104 等高速模式，切换成功后卡默认进入 SDR12 时序模式。

**本节来源**  
- [SdIoVoltage](file://src/mci_host/sd/io_voltage.rs#L0-L34)
- [switch_io_voltage](file://src/mci_host/sd/mod.rs#L422-L459)
- [sdif_device.rs](file://src/mci_host/mci_sdif/sdif_device.rs#L131-L178)

## 时钟频率与性能

不同时序模式对应不同的时钟频率配置：SDR12 使用 25MHz，SDR25 使用 50MHz，SDR50 使用 100MHz，SDR104 使用 208MHz。这些频率通过 `card_clock_set` 函数配置，并结合 `MCITiming` 结构体中的 `clk_src` 和 `clk_div` 参数实现精确分频。高频模式显著提升数据传输速率，但需配合 IO 延时调整（如 `pad_delay` 设置）和调谐过程以保证稳定性。例如，SDR104 模式下启用 `MCIPadDelay::Set` 可优化时钟输出延迟，提升高速信号质量。

**本节来源**  
- [mci_timing.rs](file://src/mci/mci_timing.rs#L0-L182)
- [SD_CLOCK_208MHZ](file://src/mci_host/sd/consts.rs#L120-L123)
- [MCIHostCapability](file://src/mci_host/constants.rs#L150-L182)