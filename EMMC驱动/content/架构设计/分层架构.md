
# 分层架构

<cite>
**本文档引用的文件**
- [regs.rs](file://src/regs.rs)
- [mci/regs.rs](file://src/mci/regs.rs)
- [mci/mod.rs](file://src/mci/mod.rs)
- [mci/mci_hardware.rs](file://src/mci/mci_hardware.rs)
- [mci_host/mod.rs](file://src/mci_host/mod.rs)
- [mci_host/mci_host_transfer.rs](file://src/mci_host/mci_host_transfer.rs)
- [mci_host/sd/mod.rs](file://src/mci_host/sd/mod.rs)
</cite>

## 目录
1. [引言](#引言)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构概述](#架构概述)
5. [详细组件分析](#详细组件分析)
6. [依赖分析](#依赖分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)

## 引言
本文档旨在为飞腾MCI驱动创建详细的分层架构文档，重点描述从硬件寄存器抽象层（regs）到MCI控制器层，再到MCI主机抽象层（MCIHost），最后到SD卡协议层的完整软件栈。文档详细说明了每一层的职责，包括regs模块如何通过tock-registers实现安全的硬件寄存器访问，MCI模块如何封装底层控制器操作，MCIHost模块如何作为高层抽象协调设备操作，以及sd模块如何实现SD卡协议细节。通过架构图展示各层之间的调用关系和数据流，例如应用层通过MCIHost::block_size_set调用最终触发MCI::trans_bytes_set的过程。此外，文档还解释了这种分层设计如何提高代码可维护性和可移植性，并举例说明新增功能（如支持新传输模式）时各层的协同方式。

## 项目结构
飞腾MCI驱动的项目结构清晰地反映了其分层设计。项目根目录下的`src`文件夹包含了所有源代码，其中`iopad`、`mci`、`mci_host`、`osa`、`python`、`aarch.rs`、`lib.rs`、`regs.rs`和`tools.rs`等子目录和文件分别负责不同的功能。`mci`目录下的多个模块文件（如`mci_cmd.rs`、`mci_cmddata.rs`等）共同构成了MCI控制器层，而`mci_host`目录下的`mci_sdif`和`sd`子目录则分别负责MCI主机抽象层和SD卡协议层。`regs.rs`文件位于项目根目录，提供了硬件寄存器的抽象访问接口。

```mermaid
graph TB
    subgraph "src"
        subgraph "iopad"
            iopad_constants["constants.rs"]
            iopad_err["err.rs"]
            iopad_mod["mod.rs"]
            iopad_regs["regs.rs"]
        end
        subgraph "mci"
            mci_consts["consts.rs"]
            mci_err["err.rs"]
            mci_cmd["mci_cmd.rs"]
            mci_cmddata["mci_cmddata.rs"]
            mci_config["mci_config.rs"]
            mci_data["mci_data.rs"]
            mci_dma["mci_dma.rs"]
            mci_hardware["mci_hardware.rs"]
            mci_intr["mci_intr.rs"]
            mci_pio["mci_pio.rs"]
            mci_timing["mci_timing.rs"]
            mci_mod["mod.rs"]
            mci_regs["regs.rs"]
        end
        subgraph "mci_host"
            subgraph "mci_sdif"
                mci_sdif_consts["consts.rs"]
                mci_sdif_mod["mod.rs"]
                mci_sdif_device["sdif_device.rs"]
            end
            subgraph "sd"
                sd_cid["cid.rs"]
                sd_consts["consts.rs"]
                sd_csd["csd.rs"]
                sd_io_voltage["io_voltage.rs"]
                sd_mod["mod.rs"]
                sd_scr["scr.rs"]
                sd_status["status.rs"]
                sd_usr_param["usr_param.rs"]
            end
            mci_host_constants["constants.rs"]
            mci_host_err["err