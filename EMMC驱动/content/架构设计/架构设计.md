
# 架构设计

<cite>
**本文档引用的文件**
- [mci_host/mod.rs](file://src/mci_host/mod.rs)
- [mci/mod.rs](file://src/mci/mod.rs)
- [mci/regs.rs](file://src/mci/regs.rs)
- [regs.rs](file://src/regs.rs)
- [mci_host/mci_sdif/sdif_device.rs](file://src/mci_host/mci_sdif/sdif_device.rs)
- [mci_host/mci_host_transfer.rs](file://src/mci_host/mci_host_transfer.rs)
- [mci/mci_cmd.rs](file://src/mci/mci_cmd.rs)
- [mci/mci_dma.rs](file://src/mci/mci_dma.rs)
- [mci/mci_hardware.rs](file://src/mci/mci_hardware.rs)
- [iopad/regs.rs](file://src/iopad/regs.rs)
- [osa/mod.rs](file://src/osa/mod.rs)
</cite>

## 目录
1. [项目结构](#项目结构)
2. [核心组件](#核心组件)
3. [分层架构概述](#分层架构概述)
4. [详细组件分析](#详细组件分析)
5. [数据流分析](#数据流分析)
6. [状态机与硬件抽象](#状态机与硬件抽象)
7. [模块依赖分析](#模块依赖分析)

## 项目结构

飞腾MCI驱动采用分层架构设计，主要分为四个核心模块：`iopad`、`mci`、`mci_host`和`osa`。每个模块都有明确的职责，共同构成了完整的SD卡驱动系统。

```mermaid
graph TD
A[应用层] --> B[MCIHost]
B --> C[MCI]
C --> D[硬件寄存器]
E[IOPad] --> C
F[OSA] --> C
G[SD协议] --> B
```

**图表来源**
- [mci_host/mod.rs](file://src/mci_host/mod.rs)
- [mci/mod.rs](file://src/mci/mod.rs)
- [iopad/regs.rs](file://src/iopad/regs.rs)
- [osa/mod.rs](file://src/osa/mod.rs)

**章节来源**
- [mci_host/mod.rs](file://src/mci_host/mod.rs)
- [mci/mod.rs](file://src/mci/mod.rs)

## 核心组件

驱动的核心组件包括MCI控制器、MCI主机抽象层和SD协议层。MCI控制器直接与硬件寄存器交互，MCI主机抽象层作为高层API入口点，SD协议层处理SD卡协议相关的命令和数据。

**章节来源**
- [mci_host/mod.rs](file://src/mci_host/mod.rs)
- [mci/mod.rs](file://src/mci/mod.rs)

## 分层架构概述

飞腾MCI驱动采用清晰的分层架构，从底层到高层依次为：硬件寄存器抽象层（regs）、MCI控制器层、MCI主机抽象层（MCIHost）和SD卡协议层。这种分层设计实现了关注点分离，提高了代码的可维护性和可扩展性。

```mermaid
graph TD
subgraph "硬件层"
H[硬件寄存器]
end
subgraph "驱动层"
MCI[MCI控制器]
IOPAD[IOPad]
OSA[OSA]
end
subgraph "抽象层"
MCIHOST[MCIHost]
end
subgraph "协议层"
SD[SD协议]
end
H --> MCI
IOPAD --> MCI
OSA --> MCI
MCI --> MCIHOST
SD --> MCIHOST
```

**图表来源**
- [mci/regs.rs](file://src/mci/regs.rs)
- [mci/mod.rs](file://src/mci/mod.rs)
- [mci_host/mod.rs](file://src/mci_host/mod.rs)

**章节来源**
- [mci/regs.rs](file://src/mci/regs.rs)
- [mci/mod.rs](file://src/mci/mod.rs)
- [mci_host/mod.rs](file://src/mci_host/mod.rs)

## 详细组件分析

### MCI控制器分析

MCI控制器是驱动的核心，负责直接与硬件寄存器交互。它通过`MCIReg`结构体提供安全的寄存器操作，实现了对SDIF控制器的完整控制。

```mermaid
classDiagram
class MCI {
+config : MCIConfig
+is_ready : bool
+desc_list : FSdifIDmaDescList
+prev_cmd : u32
+cur_cmd : Option<MCICmdData>
+curr_timing : MCITiming
+io_pad : Option<IoPad>
+new(config : MCIConfig) MCI
+config_init(config : &MCIConfig) MCIResult
+config_deinit() MCIResult
+dma_transfer(cmd_data : &mut MCICmdData) MCIResult
+pio_transfer(cmd_data : &mut MCICmdData) MCIResult
}
class MCIReg {
+addr : NonNull<u8>
+read_32(reg : u32) u32
+write_32(reg : u32, val : u32)
+read_reg~F~() F
+write_reg~F~(val : F) void
+modify_reg~F~(f : impl Fn(F) -> F) void
}
MCI --> MCIReg : "使用"
MCI --> IoPad : "依赖"
```

**图表来源**
- [mci/mod.rs](file://src/mci/mod.rs)
- [regs.rs](file://src/regs.rs)
- [iopad/regs.rs](file://src/iopad/regs.rs)

### MCIHost分析

MCIHost模块作为高层API入口点，协调MCI核心模块与SD协议模块。它提供了统一的接口供上层应用调用，同时处理与SD卡协议相关的复杂逻辑。

```mermaid
classDiagram
class MCIHost {
+dev : Box<SDIFDev>
+config : MCIHostConfig
+curr_voltage : Cell<MCIHostOperationVoltage>
+curr_bus_width : u32
+curr_clock_freq : Cell<u32>
+source_clock_hz : u32
+capability : MCIHostCapability
+max_block_count : Cell<u32>
+max_block_size : u32
+tuning_type : u8
+cd : Option<Rc<MCIHostCardDetect>>
+card_int : MCIHostCardIntFn
+new(dev : Box<SDIFDev>, config : MCIHostConfig) Self
+card_select(relative_address : u32, is_selected : bool) MCIHostStatus
+application_command_send(relative_address : u32) MCIHostStatus
+block_count_set(block_count : u32) MCIHostStatus
+go_idle() MCIHostStatus
+block_size_set(block_size : u32) MCIHostStatus
+card_inactive_set() MCIHostStatus
+init(addr : NonNull<u8>) MCIHostStatus
}
class SDIFDev {
+hc : RefCell<MCI>
+hc_cfg : RefCell<MCIConfig>
+rw_desc : PoolBuffer
+desc_num : Cell<u32>
+new(addr : NonNull<u8>, desc_num : usize) Self
+iopad_set(iopad : IoPad) void
+init(addr : NonNull<u8>, host : &MCIHost) MCIHostStatus
+reset() MCIHostStatus
+switch_to_voltage(voltage : MCIHostOperationVoltage, host : &MCIHost) MCIHostStatus
+transfer_function(content : &mut MCIHostTransfer, host : &MCIHost) MCIHostStatus
}
MCIHost --> SDIFDev : "包含"
MCIHost --> MCIHostConfig : "使用"
MCIHost --> MCIHostCardDetect : "可选依赖"
```

**图表来源**
- [mci_host/mod.rs](file://src/mci_host/mod.rs)
- [mci_host/mci_sdif/sdif_device.rs](file://src/mci_host/mci_sdif/sdif_device.rs)
- [mci_host/mci_host_config.rs](file://src/mci_host/mci_host_config.rs)

### SD协议分析

SD协议层处理SD卡协议相关的命令和数据，包括CID、CSD、SCR等信息的解析和处理。它与MCIHost模块紧密协作，实现完整的SD卡功能。

```mermaid
classDiagram
class SdCid {
+manufacturer_id : u8
+application_id : u16
+product_name : [u8; 5]
+product_version : u8
+serial_number : u32
+manufacturing_data : u16
+new() Self
}
class SdCsd {
+csd_structure : u8
+data_read_access_time1 : u8
+data_read_access_time2 : u8
+transfer_speed : u8
+card_command_classes : u16
+read_block_length : u8
+flags : u16
+device_size : u32
+read_current_vdd_min : u8
+read_current_vdd_max : u8
+write_current_vdd_min : u8
+write_current_vdd_max : u8
+device_size_multiplier : u8
+erase_sector_size : u8
+write_protect_group_size : u8
+write_speed_factor : u8
+write_block_length : u8
+file_format : u8
+new() Self
}
class SdScr {
+scr_structure : u8
+sd_specification : u8
+flags : u16
+sd_security : u8
+sd_bus_widths : u8
+extended_security : u8
+command_support : u8
+reserved_for_manufacturer : u32
+new() Self
}
class SdStatus {
+bus_width : u8
+secure_mode : u8
+card_type : u16
+protected_size : u32
+speed_class : u8
+performance_move : u8
+au_size : u8
+erase_size : u16
+erase_timeout : u8
+erase_offset : u8
+uhs_speed_grade : u8
+uhs_au_size : u8
+new() Self
}
SdCid <|-- SdCardInfo : "组合"
SdCsd <|-- SdCardInfo : "组合"
SdScr <|-- SdCardInfo : "组合"
SdStatus <|-- SdCardInfo : "组合"
```

**图表来源**
- [mci_host/sd/cid.rs](file://src/mci_host/sd/cid.rs)
- [mci_host/sd/csd.rs](file://src/mci_host/sd/csd.rs)
- [mci_host/sd/scr.rs](file://src/mci_host/sd/scr.rs)
- [mci_host/sd/status.rs](file://src/mci_host/sd/status.rs)

**章节来源**
- [mci_host/sd/cid.rs](file://src/mci_host/sd/cid.rs)
- [mci_host/sd/csd.rs](file://src/mci_host/sd/csd.rs)
- [mci_host/sd/scr.rs](file://src/mci_host/sd/scr.rs)
- [mci_host/sd/status.rs](file://src/mci_host/sd/status.rs)

## 数据流分析

### 读写块命令数据流

当应用层发起读写块命令时，数据流从应用层经过MCIHost、MCI控制器，最终到达硬件寄存器。这个过程涉及多个模块的协作和状态转换。

```mermaid
sequenceDiagram
participant App as "应用层"
participant MCIHost as "MCIHost"
participant SDIFDev as "SDIFDev"
participant MCI as "MCI"
participant Reg as "硬件寄存器"
App->>MCIHost : 读写块命令
MCIHost->>SDIFDev : transfer_function()
SDIFDev->>MCI : covert_command_info()
MCI->>MCI : cmd_transfer()
MCI->>Reg : 写入命令寄存器
Reg-->>MCI : 命令完成中断
MCI->>MCI : cmd_response_get()
MCI->>Reg : 数据传输
Reg-->>MCI : 数据传输完成
MCI-->>SDIFDev : 返回结果
SDIFDev-->>MCIHost : 返回结果
MCIHost-->>App : 返回结果
```

**图表来源**
- [mci_host/mod.rs](file://src/mci_host/mod.rs)
- [mci_host/mci_sdif/sdif_device.rs](file://src/mci_host/mci_sdif/sdif_device.rs)
- [mci/mod.rs](file://src/mci/mod.rs)
- [mci/mci_cmd.rs](file://src/mci/mci_cmd.rs)

**章节来源**
- [mci_host/mod.rs](file://src/mci_host/mod.rs)
- [mci_host/mci_sdif/sdif_device.rs](file://src/mci_host/mci_sdif/sdif_device.rs)
- [mci/mod.rs](file://src/mci/mod.rs)

## 状态机与硬件抽象

### 卡状态管理状态机

驱动使用状态机模式来管理SD卡的状态，确保在不同操作之间正确地转换状态。这种设计提高了系统的可靠性和稳定性。

```mermaid
stateDiagram-v2
[*] --> Idle
Idle --> Initializing : "上电"
Initializing --> Ready : "初始化完成"
Ready --> Transfering : "读写命令"
Transfering --> Ready : "传输完成"
Ready --> Programming : "编程命令"
Programming --> Ready : "编程完成"
Ready --> Disconnecting : "断开连接"
Disconnecting --> Idle : "连接断开"
Ready --> Error : "错误"
Error --> Ready : "恢复"
```

**图表来源**
- [mci_host/mod.rs](file://src/mci_host/mod.rs)
- [mci/mod.rs](file://src/mci/mod.rs)

### 硬件抽象模式

驱动使用tock-registers库实现安全的寄存器操作。通过`Reg`结构体和`FlagReg` trait，提供了类型安全的寄存器访问接口，避免了直接的内存操作带来的风险。

```mermaid
classDiagram
class Reg~E~ {
+addr : NonNull<u8>
+_marker : PhantomData<E>
+new(addr : NonNull<u8>) Self
+read_32(reg : u32) u32
+write_32(reg : u32, val : u32)
+read_reg~F~() F
+write_reg~F~(val : F)
+modify_reg~F~(f : impl Fn(F) -> F)
+clear_reg~F~(val : F)
+set_reg~F~(val : F)
}
class FlagReg {
<<trait>>
+REG : u32
}
class MCICtrl {
+CONTROLLER_RESET : u32
+FIFO_RESET : u32
+DMA_RESET : u32
+INT_ENABLE : u32
+DMA_ENABLE : u32
+READ_WAIT : u32
+SEND_IRQ_RESPONSE : u32
+ABORT_READ_DATA : u32
+SEND_CCSD : u32
+SEND_AUTO_STOP_CCSD : u32
+ENDIAN : u32
+CARD_VOLTAGE_A_MASK : u32
+CARD_VOLTAGE_B_MASK : u32
+ENABLE_OD_PULLUP : u32
+USE_INTERNAL_DMAC : u32
}
Reg~E~ <|-- MCIReg
FlagReg <|-- MCICtrl
MCIReg --> MCICtrl : "读写"
```

**图表来源**
-