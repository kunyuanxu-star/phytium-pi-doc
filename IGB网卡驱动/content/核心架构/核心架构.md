# 核心架构

<cite>
**本文档引用的文件**
- [lib.rs](file://igb/src/lib.rs)
- [mac.rs](file://igb/src/mac.rs)
- [phy.rs](file://igb/src/phy.rs)
- [ring/mod.rs](file://igb/src/ring/mod.rs)
- [ring/rx.rs](file://igb/src/ring/rx.rs)
- [ring/tx.rs](file://igb/src/ring/tx.rs)
- [descriptor.rs](file://igb/src/descriptor.rs)
</cite>

## 目录
1. [引言](#引言)
2. [分层设计模式](#分层设计模式)
3. [Igb聚合根结构体](#igb聚合根结构体)
4. [硬件寄存器安全封装](#硬件寄存器安全封装)
5. [物理层连接管理](#物理层连接管理)
6. [异步编程模型集成](#异步编程模型集成)
7. [共享状态资源管理](#共享状态资源管理)
8. [组件交互与数据流](#组件交互与数据流)
9. [设计决策与权衡](#设计决策与权衡)

## 引言

本驱动程序为Intel IGB以太网控制器提供了一个现代化的Rust实现，采用分层架构设计，旨在提供高性能、内存安全和可维护的网络驱动解决方案。该驱动程序专为`no-std`环境设计，适用于嵌入式系统和操作系统内核开发场景。

驱动程序的核心设计理念是将复杂的硬件交互分解为清晰的抽象层次：硬件抽象层负责直接与设备寄存器通信，设备控制层管理MAC和PHY控制器的逻辑，而数据流管理层则处理数据包的接收和发送。这种分层方法不仅提高了代码的可读性和可测试性，还增强了系统的可靠性和安全性。

通过结合Rust语言的所有权系统、生命周期管理和类型安全特性，该驱动程序在不牺牲性能的前提下，有效避免了传统C语言驱动中常见的内存错误和并发问题。同时，对`futures::Stream`的集成使得驱动程序能够无缝融入异步运行时环境，支持现代应用程序的非阻塞I/O需求。

**Section sources**
- [lib.rs](file://igb/src/lib.rs#L1-L178)

## 分层设计模式

### 硬件抽象层（HAL）

硬件抽象层基于`tock-registers`库构建，为底层硬件寄存器提供了类型安全的访问接口。该层通过声明式的宏定义（`register_structs!`和`register_bitfields!`）将复杂的寄存器布局和位字段映射到Rust类型系统中，从而实现了编译时的安全检查和语义化的寄存器操作。

在`mac.rs`文件中，`MacRegister`结构体定义了Intel IGB控制器所有关键寄存器的内存映射，包括控制寄存器（CTRL）、状态寄存器（STATUS）、中断控制寄存器（IMS/IMC）等。每个寄存器都被赋予了适当的读写权限（`ReadWrite`、`ReadOnly`），并使用位字段枚举来表示各个功能位，如全双工模式、速度选择和链路状态等。

这种设计模式消除了直接进行位操作的风险，开发者可以通过语义化的方法调用（如`reg.modify(CTRL::FD::FullDuplex)`）来修改寄存器值，而不是使用容易出错的位掩码运算。此外，内存屏障（`mbarrier::mb`）的显式插入确保了寄存器操作的顺序性，这对于保证硬件状态的一致性至关重要。

**Section sources**
- [mac.rs](file://igb/src/mac.rs#L10-L692)

### 设备控制层

设备控制层由`Mac`和`Phy`两个核心结构体组成，它们分别封装了媒体访问控制（MAC）子层和物理层（PHY）的控制逻辑。`Mac`结构体作为主要的硬件控制器，通过`NonNull<MacRegister>`指针直接访问设备的内存映射I/O空间，提供了对各种硬件功能的高级封装。

`Phy`结构体的设计体现了依赖注入原则，它持有一个`Mac`实例的副本，通过MAC提供的MDI接口与外部PHY芯片通信。这种设计避免了全局状态，使得PHY操作完全依赖于其所属的MAC控制器，增强了模块的独立性和可测试性。

两个控制器都遵循"构造函数-方法"模式，通过`new`函数创建实例，并提供一系列语义化的方法来执行具体操作。例如，`Mac`结构体提供了`enable_rx()`、`disable_tx()`等方法来控制数据路径，而`Phy`结构体则提供了`power_up()`、`enable_auto_negotiation()`等方法来管理物理层连接状态。

**Section sources**
- [mac.rs](file://igb/src/mac.rs#L694-L792)
- [phy.rs](file://igb/src/phy.rs#L344-L443)

### 数据流管理层

数据流管理层由`ring`模块实现，负责管理数据包的接收和发送队列。该层采用了经典的环形描述符队列（Ring Descriptor Queue）设计模式，这是高性能网络驱动的标准实践。`RxRing`和`TxRing`结构体分别代表接收和发送环，它们封装了底层的环形缓冲区操作，向高层提供了简洁的数据包提交和获取接口。

`Ring<D: Descriptor>`泛型结构体是这一层的核心，它通过关联的描述符类型（`AdvRxDesc`或`AdvTxDesc`）实现了类型安全的队列操作。每个环形队列都维护着头部（Head）和尾部（Tail）指针，分别指示硬件当前正在处理的位置和软件可以提交新工作的位置。

为了支持异步操作，`RxRing`实现了`Stream`特质，允许使用者以拉取方式获取接收到的数据包。当有新的数据包到达时，硬件会更新描述符的状态，驱动程序通过轮询头部指针的变化来检测完成事件，并将相应的数据包封装为`RxPacket`返回给使用者。

**Section sources**
- [ring/mod.rs](file://igb/src/ring/mod.rs#L1-L164)
- [ring/rx.rs](file://igb/src/ring/rx.rs#L1-L249)
- [ring/tx.rs](file://igb/src/ring/tx.rs#L1-L194)

## Igb聚合根结构体

`Igb`结构体作为整个驱动程序的聚合根，扮演着协调者和门面（Facade）的角色。它将分散的`Mac`和`Phy`控制器以及`RxRing`和`TxRing`队列整合到一个统一的接口之下，为上层应用提供了简化的API。

```mermaid
classDiagram
    class Igb {
        +mac: Mac
        +phy: Phy
        +_rx_ring_addrs: [usize; 16]
        +_tx_ring_addrs: [usize; 16]
        +new(iobase) Result<Igb, DError>
        +open() Result<(), DError>
        +new_ring() Result<(TxRing, RxRing), DError>
        +read_mac() MacAddr6
        +status() MacStatus
        +handle_interrupt()
    }
    
    class Mac {
        +iobase: NonNull<u8>
        +reg: NonNull<MacRegister>
        +new(iobase) Mac
        +reset() Result<(), DError>
        +enable_rx()
        +disable_tx()
        +read_mdic(phys_addr, offset) Result<u16, DError>
        +write_mdic(phys_addr, offset, data) Result<(), DError>
    }
    
    class Phy {
        +mac: Mac
        +addr: u32
        +new(mac) Phy
        +power_up() Result<(), DError>
        +enable_auto_negotiation() Result<(), DError>
        +wait_for_auto_negotiation_complete() Result<(), DError>
    }
    
    class RxRing {
        +send(request) Result<(), DError>
        +next_finished() Option<Request>
    }
    
    class TxRing {
        +submit(request) Result<(), DError>
        +next_pkt() Option<RxPacket>
    }
    
    Igb --> Mac : "包含