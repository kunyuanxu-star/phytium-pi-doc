# 快速开始指南

<cite>
**Referenced Files in This Document**   
- [Cargo.toml](file://Cargo.toml)
- [src/lib.rs](file://src/lib.rs)
</cite>

## 目录
1. [简介](#简介)
2. [添加依赖](#添加依赖)
3. [初始化流程](#初始化流程)
4. [基本操作API](#基本操作api)
5. [典型应用示例](#典型应用示例)
6. [常见错误与解决方案](#常见错误与解决方案)
7. [总结](#总结)

## 简介

`phytium-pi-pwm` 是一个专为 Phytium Pi 平台设计的 PWM（脉宽调制）驱动库，适用于 `no_std` 环境下的 Rust 嵌入式开发。本快速入门教程将指导开发者如何在项目中集成该库，并演示从初始化到基本操作的完整流程。内容特别针对嵌入式 Rust 新手进行了优化，确保易于理解和使用。

**Section sources**
- [src/lib.rs](file://src/lib.rs#L1-L50)

## 添加依赖

要在您的 `no_std` Rust 项目中使用 `phytium-pi-pwm` 库，首先需要在项目的 `Cargo.toml` 文件中添加相应的依赖项。这一步是集成该 PWM 驱动的基础。

```toml
[dependencies]
phytium-pi-pwm = { git = "https://github.com/arceos-org/phytium-pi-pwm" }
```

此外，由于该库本身依赖于一些核心 crate，您可能还需要确保您的项目中包含了这些依赖，例如 `tock-registers`、`log` 和 `spin`，以保证兼容性。

**Section sources**
- [Cargo.toml](file://Cargo.toml#L1-L23)

## 初始化流程

成功添加依赖后，下一步是初始化 PWM 控制器。此过程分为两个主要步骤：创建配置实例和调用初始化函数。

### 创建 PwmConfig 实例

首先，您需要创建一个 `PwmConfig` 结构体的实例来配置 PWM 控制器。该结构体实现了 `Default` trait，因此您可以直接使用默认值进行初始化，这对于快速上手非常方便。

```rust
let config = PwmConfig::default();
```

如果您需要自定义配置，例如更改基地址或默认周期，可以手动设置 `PwmConfig` 的字段。

### 调用 init_pwm 函数

配置完成后，调用 `init_pwm` 函数并传入配置实例即可完成初始化。该函数会返回一个 `Result` 类型，用于指示初始化是否成功。

```rust
match init_pwm(config) {
    Ok(()) => log::info!("PWM 初始化成功"),
    Err(e) => log::error!("PWM 初始化失败: {}", e),
}
```

**Section sources**
- [src/lib.rs](file://src/lib.rs#L280-L295)
- [src/lib.rs](file://src/lib.rs#L250-L278)

## 基本操作API

初始化成功后，您可以通过 `api` 模块提供的便捷函数来控制 PWM。这些函数封装了底层操作，使接口更加简洁易用。

### 设置占空比

使用 `set_duty_cycle` 函数可以设置 PWM 信号的占空比。参数为百分比值（1-100），例如设置 75% 的占空比：

```rust
api::set_duty_cycle(75);
```

### 启用/禁用 PWM

通过 `enable` 和 `disable` 函数可以分别启用和禁用 PWM 输出：

```rust
api::enable();  // 启用 PWM
// ... 执行其他操作 ...
api::disable(); // 禁用 PWM
```

### 获取当前状态

您还可以使用 `get_duty_cycle` 和 `is_enabled` 函数来查询当前的占空比和使能状态。

**Section sources**
- [src/lib.rs](file://src/lib.rs#L300-L315)
- [src/lib.rs](file://src/lib.rs#L250-L278)

## 典型应用示例

以下是一个完整的代码示例，展示如何使用 `phytium-pi-pwm` 库来周期性地调整 LED 的亮度，实现呼吸灯效果。

```rust
use phytium_pi_pwm::{init_pwm, PwmConfig, api};

fn breathing_led() -> Result<(), &'static str> {
    // 1. 使用默认配置初始化 PWM
    let config = PwmConfig::default();
    init_pwm(config)?;

    // 2. 启用 PWM 输出
    api::enable()?;

    // 3. 循环调整占空比，实现呼吸效果
    for duty in (0..=100).chain((1..100).rev()) {
        api::set_duty_cycle(duty)?;
        // 此处应添加适当的延时函数
        delay_ms(20);
    }

    Ok(())
}
```

在这个示例中，程序首先初始化 PWM，然后在一个循环中逐步增加再减少占空比，从而让连接到 PWM 引脚的 LED 亮度平滑变化，模拟出呼吸的效果。

**Section sources**
- [src/lib.rs](file://src/lib.rs#L250-L315)

## 常见错误与解决方案

在使用过程中，可能会遇到一些常见的问题，了解这些问题及其解决方案有助于提高开发效率。

### 重复初始化错误

如果尝试多次调用 `init_pwm` 函数，将会收到 `"PWM already initialized"` 的错误信息。这是因为库内部使用了一个全局静态变量来确保单例模式。

**解决方案**：在调用 `init_pwm` 之前，检查是否已经初始化，或者确保在整个程序生命周期中只调用一次。

### 占空比范围限制

`set_duty_cycle` 函数要求占空比必须在 1 到 100 之间。传入 0 或大于 100 的值会导致 `"Duty cycle must be between 1-100"` 错误。

**解决方案**：在调用函数前对输入值进行验证和裁剪，确保其符合要求。

**Section sources**
- [src/lib.rs](file://src/lib.rs#L180-L190)
- [src/lib.rs](file://src/lib.rs#L280-L295)

## 总结

本文档详细介绍了如何将 `phytium-pi-pwm` 库集成到 `no_std` Rust 项目中。从添加 Cargo 依赖，到使用默认配置初始化控制器，再到通过简洁的 API 进行基本操作，整个流程清晰明了。通过提供的呼吸灯示例，开发者可以快速掌握库的使用方法。同时，我们也指出了常见的错误来源及应对策略，帮助开发者避免陷阱，顺利实现 PWM 功能。