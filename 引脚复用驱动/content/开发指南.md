# 开发指南

<cite>
**本文档引用的文件**
- [lib.rs](file://src/lib.rs)
- [Cargo.toml](file://Cargo.toml)
</cite>

## 目录
1. [简介](#简介)
2. [开发环境搭建](#开发环境搭建)
3. [代码贡献流程](#代码贡献流程)
4. [编译与构建方法](#编译与构建方法)
5. [no-std兼容性验证](#no-std兼容性验证)
6. [日志与运行时诊断](#日志与运行时诊断)
7. [测试策略与架构规划](#测试策略与架构规划)
8. [仿真与调试技巧](#仿真与调试技巧)
9. [功能扩展指导](#功能扩展指导)
10. [代码风格与文档规范](#代码风格与文档规范)
11. [提交PR与代码审查](#提交pr与代码审查)

## 简介
本项目为飞腾派（Phytium Pi）平台的引脚控制驱动，基于Rust语言实现，适用于嵌入式无操作系统（no-std）环境。当前项目处于初期阶段，`src/lib.rs`中仅包含基础框架和TODO注释，尚未实现具体功能。本文档面向未来贡献者，提供完整的开发指导，涵盖环境配置、代码编写、测试调试及协作流程。

## 开发环境搭建
为进行本项目的开发，需配置Rust嵌入式开发环境：
1. 安装`rustup`：通过官方脚本安装Rust工具链。
2. 设置默认版本为`nightly`（嵌入式开发常用）：
   ```bash
   rustup default nightly
   ```
3. 添加目标支持：
   ```bash
   rustup target add riscv32imac-unknown-none-elf
   ```
   根据实际硬件架构选择合适的目标三元组。
4. 配置Cargo：在项目根目录或`~/.cargo/config.toml`中设置交叉编译参数，指定链接器和运行时行为。

**Section sources**
- [Cargo.toml](file://Cargo.toml#L1-L14)

## 代码贡献流程
1. Fork仓库并克隆本地。
2. 创建新分支用于功能开发或问题修复。
3. 编辑`src/lib.rs`实现具体功能。
4. 确保代码符合Rust格式化标准（使用`cargo fmt`）。
5. 提交更改并推送至远程分支。
6. 在GitHub上发起Pull Request（PR），描述变更内容与动机。

## 编译与构建方法
使用Cargo进行项目构建：
```bash
cargo build --target riscv32imac-unknown-none-elf
```
此命令将根据`Cargo.toml`中的依赖项和目标配置，生成适用于目标平台的二进制文件。确保已正确安装目标支持和交叉编译工具链。

**Section sources**
- [Cargo.toml](file://Cargo.toml#L1-L14)

## no-std兼容性验证
项目已声明`#![no_std]`，表明其运行于无标准库环境。使用以下命令验证兼容性：
```bash
cargo check --target riscv32imac-unknown-none-elf
```
该命令检查代码是否仅依赖`core`库而非`std`，确保在资源受限设备上的可移植性。

**Section sources**
- [lib.rs](file://src/lib.rs#L1)

## 日志与运行时诊断
项目已引入`log` crate作为日志接口。建议在关键路径添加日志输出以便调试：
```rust
use log::info;
info!("初始化引脚 {}", pin_number);
```
实际日志后端需由上层系统提供（如`defmt`或串口输出）。启用日志有助于追踪运行时状态和排查问题。

**Section sources**
- [Cargo.toml](file://Cargo.toml#L14)

## 测试策略与架构规划
尽管当前项目缺乏测试文件，建议未来采用分层测试策略：
- **单元测试**：在`lib.rs`内部编写`#[cfg(test)]`模块，测试寄存器操作逻辑。
- **集成测试**：在`tests/`目录下创建独立二进制，模拟硬件交互。
- **仿真测试**：结合QEMU或FPGA仿真环境验证驱动行为。
建议组织如下：
```
tests/
├── unit_test.rs
└── integration_pinctrl.rs
```

## 仿真与调试技巧
推荐使用以下工具进行调试：
- **probe-run**：实时运行并查看`defmt`日志输出：
  ```bash
  cargo run --target riscv32imac-unknown-none-elf
  ```
- **QEMU**：模拟RISC-V环境进行功能验证。
- **gdb**：配合`cargo-gdb`进行断点调试。
通过这些工具可有效分析驱动执行流程与硬件交互时序。

## 功能扩展指导
### 模块结构设计
在`lib.rs`中按功能划分模块，例如：
```rust
mod registers; // 寄存器映射定义
mod pin;      // 引脚抽象
mod config;   // 配置方法
```

### 寄存器映射定义
使用`tock-registers`库安全地定义硬件寄存器：
```rust
use tock_registers::registers::ReadWrite;
use tock_registers::register_bitfields;

register_bitfields![u32,
    GPIO_CTRL [
        MODE OFFSET(0) NUMBITS(3) [],
        PULL OFFSET(3) NUMBITS(2) []
    ]
];
```

### 引脚配置方法实现
定义公共API以配置引脚模式、上下拉等：
```rust
pub fn set_pin_mode(&self, mode: PinMode) -> Result<(), Error>;
```

**Section sources**
- [lib.rs](file://src/lib.rs#L1-L3)
- [Cargo.toml](file://Cargo.toml#L13)

## 代码风格与文档规范
- **格式化**：遵循`rustfmt`默认规则，提交前执行`cargo fmt`。
- **文档注释**：所有公共接口必须使用`///` doc注释说明用途、参数与返回值。
- **内联注释**：复杂逻辑处使用`//`解释实现原理。
- **提交信息**：采用Conventional Commits格式，如`feat(pinctrl): add pin mode configuration`。

**Section sources**
- [lib.rs](file://src/lib.rs#L1-L3)

## 提交PR与代码审查
1. PR标题应清晰描述变更内容。
2. 正文需包含变更背景、实现方式与测试情况。
3. 维护团队将在1-3个工作日内反馈。
4. 沟通渠道包括GitHub Issues、Discussions及官方邮件列表。
5. 所有贡献者需签署CLA（贡献者许可协议）。

**Section sources**
- [Cargo.toml](file://Cargo.toml#L6)