# 贡献指南

<cite>
**本文档引用的文件**
- [rust-toolchain.toml](file://rust-toolchain.toml)
- [Cargo.toml](file://Cargo.toml)
- [usb-host/Cargo.toml](file://usb-host/Cargo.toml)
- [usb-host/README.md](file://usb-host/README.md)
- [usb-host/CHANGELOG.md](file://usb-host/CHANGELOG.md)
- [test_crates/test_xhci_uvc/README.md](file://test_crates/test_xhci_uvc/README.md)
- [test_crates/test_xhci_uvc/CHANGELOG.md](file://test_crates/test_xhci_uvc/CHANGELOG.md)
- [usb-device/uvc/README.md](file://usb-device/uvc/README.md)
- [usb-device/hid/keyboard/README.md](file://usb-device/hid/keyboard/README.md)
</cite>

## 目录
1. [本地开发环境设置](#本地开发环境设置)
2. [测试与文档预览](#测试与文档预览)
3. [代码提交规范](#代码提交规范)
4. [功能设计评审流程](#功能设计评审流程)
5. [向后兼容性政策](#向后兼容性政策)
6. [社区参与与协作路线图](#社区参与与协作路线图)

## 本地开发环境设置

本项目通过 `rust-toolchain.toml` 文件精确指定编译器版本，确保所有贡献者使用一致的工具链。开发者必须配置本地环境以匹配此要求。

当前项目使用的 Rust 工具链为 `nightly-2025-08-15` 版本，并包含 `rustfmt`、`clippy` 等关键组件。开发者应确保已安装相应工具链：

```bash
rustup install nightly-2025-08-15
rustup component add rustfmt clippy --toolchain nightly-2025-08-15
```

项目针对嵌入式环境构建，目标平台为 `aarch64-unknown-none-softfloat`。开发者需确保交叉编译环境已正确配置。

**Section sources**
- [rust-toolchain.toml](file://rust-toolchain.toml)
- [usb-host/README.md](file://usb-host/README.md)

## 测试与文档预览

项目提供完整的测试套件，贡献者在提交代码前必须运行相关测试。测试可通过以下命令执行：

```bash
cargo test -p crab-usb --test test --target aarch64-unknown-none-softfloat -- --show-output
```

对于 UVC（USB Video Class）相关功能的测试，可使用专门的测试包：

```bash
cargo test --package test_xhci_uvc --test test --target aarch64-unknown-none-softfloat -- --show-output --uboot | tee target/uvc.log
```

测试日志可用于生成视频帧解析报告：

```bash
cargo run -p uvc-frame-parser -- -l target/uvc.log -o target/output
```

文档预览可通过 Cargo 自带的文档生成功能实现：

```bash
cargo doc --open
```

这将生成并打开本地文档，便于验证 API 文档的完整性和准确性。

**Section sources**
- [test_crates/test_xhci_uvc/README.md](file://test_crates/test_xhci_uvc/README.md)
- [usb-host/README.md](file://usb-host/README.md)

## 代码提交规范

所有代码提交必须遵循严格的格式要求，以确保代码库的历史记录清晰可读。

### Commit Message 规范

Commit 消息应采用结构化格式：
- 类型：feat、fix、docs、style、refactor、test、chore
- 范围：受影响的模块（如 usb-host、uvc、libusb）
- 主题：简明扼要的描述

示例：
```
feat(usb-host): 添加对 USB 3.1 设备的支持
fix(libusb): 修复 ISO 传输内存泄漏问题
```

### 变更日志条目

每个影响用户的功能变更或修复都必须在相应模块的 `CHANGELOG.md` 文件中添加条目。条目应包含：
- 更改类型（Added、Fixed、Changed）
- 具体描述
- 关联的 Pull Request 编号（如适用）

例如，在 `usb-host/CHANGELOG.md` 中添加：
```markdown
### Added
- 添加对新型号摄像头设备的识别支持 ([#25])
```

**Section sources**
- [usb-host/CHANGELOG.md](file://usb-host/CHANGELOG.md)
- [test_crates/test_xhci_uvc/CHANGELOG.md](file://test_crates/test_xhci_uvc/CHANGELOG.md)

## 功能设计评审流程

新增功能必须经过正式的设计评审流程，以确保架构一致性、性能最优和接口合理性。

### 设计提案

贡献者应首先在 GitHub Discussions 或 Issues 中提出功能设计草案，内容包括：
- 功能需求和使用场景
- API 设计方案
- 与其他模块的交互方式
- 潜在的性能影响评估

### 性能影响评估

所有涉及数据传输路径、中断处理或内存管理的变更必须进行性能影响评估。评估应包括：
- 对实时性的影响
- 内存占用变化
- CPU 使用率预期
- DMA 效率分析

特别是对于 UVC 视频流等高带宽应用场景，必须提供带宽利用率估算和缓冲区策略说明。

**Section sources**
- [usb-host/README.md](file://usb-host/README.md)
- [usb-device/uvc/README.md](file://usb-device/uvc/README.md)

## 向后兼容性政策

本项目严格维护向后兼容性，特别是在公共 API 和数据格式方面。

### 版本控制

项目遵循语义化版本控制（Semantic Versioning）。重大变更（破坏性变更）只能在主版本号升级时引入。

### 兼容性保证

- **公共 API**：现有公共函数、结构体和枚举的签名不得更改
- **数据格式**：设备描述符解析结果、错误类型等数据格式保持稳定
- **行为一致性**：现有功能的行为逻辑不得改变

若必须引入破坏性变更，应：
1. 提供充分的弃用警告周期
2. 实现向后兼容的适配层
3. 在变更日志中明确标注不兼容点

**Section sources**
- [usb-host/Cargo.toml](file://usb-host/Cargo.toml)
- [usb-host/CHANGELOG.md](file://usb-host/CHANGELOG.md)

## 社区参与与协作路线图

我们积极鼓励社区参与，共同推动 CrabUSB 项目的发展。

### 协作路线图

短期目标（未来 3 个月）：
- 增强对更多 UVC 摄像头型号的支持
- 优化 libusb 后端的错误处理机制
- 完善键盘 HID 设备的修饰键支持

中期目标（未来 6 个月）：
- 实现 USB Audio Class 支持
- 添加对 xHCI 调试端口的支持
- 提升文档覆盖率至 95% 以上

长期愿景：
- 成为嵌入式系统领域最可靠的 Rust USB 主机栈
- 支持更多硬件平台和操作系统集成
- 构建丰富的设备驱动生态系统

贡献者可通过提交 Issue、参与讨论、编写文档或实现新功能等方式参与项目。我们承诺对所有贡献给予及时反馈和指导。

**Section sources**
- [README.md](file://README.md)
- [usb-host/README.md](file://usb-host/README.md)
- [usb-device/uvc/README.md](file://usb-device/uvc/README.md)
- [usb-device/hid/keyboard/README.md](file://usb-device/hid/keyboard/README.md)