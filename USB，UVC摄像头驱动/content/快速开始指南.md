
# 快速开始指南

<cite>
**本文档中引用的文件**  
- [rust-toolchain.toml](file://rust-toolchain.toml)
- [README.md](file://README.md)
- [test_xhci_uvc/Cargo.toml](file://test_crates/test_xhci_uvc/Cargo.toml)
- [test_libusb/Cargo.toml](file://test_crates/test_libusb/Cargo.toml)
- [usb-host/src/lib.rs](file://usb-host/src/lib.rs)
- [usb-if/src/lib.rs](file://usb-if/src/lib.rs)
- [test_xhci_uvc/src/lib.rs](file://test_crates/test_xhci_uvc/src/lib.rs)
- [test_libusb/src/lib.rs](file://test_crates/test_libusb/src/lib.rs)
- [usb-host/src/backend/mod.rs](file://usb-host/src/backend/mod.rs)
- [usb-host/src/backend/libusb/mod.rs](file://usb-host/src/backend/libusb/mod.rs)
- [usb-host/src/backend/xhci/mod.rs](file://usb-host/src/backend/xhci/mod.rs)
- [test_crates/test_libusb_uvc/src/main.rs](file://test_crates/test_libusb_uvc/src/main.rs)
- [test_crates/test_xhci_uvc/README.md](file://test_crates/test_xhci_uvc/README.md)
</cite>

## 目录
1. [简介](#简介)
2. [环境搭建与依赖安装](#环境搭建与依赖安装)
3. [工作区初始化与工具链配置](#工作区初始化与工具链配置)
4. [示例项目选择与构建](#示例项目选择与构建)
5. [关键配置选项说明](#关键配置选项说明)
6. [设备连接与基本传输操作演示](#设备连接与基本传输操作演示)
7. [运行结果验证与调试建议](#运行结果验证与调试建议)
8. [后续学习资源](#后续学习资源)

## 简介
CrabUSB 是一个高性能、异步的 USB 主机驱动实现，专为嵌入式系统和操作系统内核设计。本教程面向零基础开发者，逐步指导如何完成 CrabUSB 的环境配置、依赖安装以及首个示例程序的编译与运行。

**Section sources**
- [README.md](file://README.md#L0-L53)

## 环境搭建与依赖安装
要使用 CrabUSB，首先需要确保系统中已安装必要的开发工具：

1. **Rust 工具链**：通过 `rustup` 安装最新版本的 Rust。
2. **libusb 开发库**（仅限用户空间测试）：
   - Ubuntu/Debian: `sudo apt install libusb-1.0-0-dev`
   - CentOS/RHEL: `sudo yum install libusbx-devel`
3. **目标平台交叉编译支持**（如 aarch64-none-softfloat）

这些依赖项是运行基于 `libusb` 后端示例所必需的基础组件。

**Section sources**
- [README.md](file://README.md#L0-L53)

## 工作区初始化与工具链配置
CrabUSB 使用 `rust-toolchain.toml` 文件精确指定所需的 Rust 版本和组件，确保所有开发者使用一致的构建环境。

```toml
[toolchain]
channel = "nightly-2025-08-15"
components = ["rust-src", "llvm-tools", "rustfmt", "clippy"]
targets = [
  "aarch64-unknown-none-softfloat",
]
```

该配置指定了以下内容：
- 使用特定日期的 Nightly 版本以保证稳定性
- 包含 `rust-src` 用于 `#![no_std]` 环境下的编译
- 支持 `aarch64-unknown-none-softfloat` 目标平台，适用于无操作系统嵌入式场景

执行 `rustup show` 可确认当前工具链是否匹配要求。

**Section sources**
- [rust-toolchain.toml](file://rust-toolchain.toml#L0-L6)

## 示例项目选择与构建
CrabUSB 提供多个测试用例，适合新手入门的最小可执行示例如下：

### 基于 libusb 的 UVC 摄像头测试（推荐初学者）
位于 `test_crates/test_libusb_uvc`，此示例在用户空间运行，便于调试。

#### 构建命令
```bash
cargo run --package test_libusb_uvc
```

#### 运行前提
- 确保已连接兼容的 USB 摄像头（UVC 设备）
- 正确安装 `libusb` 库

### 基于 xHCI 的硬件级测试
位于 `test_crates/test_xhci_uvc`，用于直接访问 xHCI 控制器，需在裸机或内核环境中运行。

#### 构建命令
```bash
cargo test --package test_xhci_uvc --target aarch64-unknown-none-softfloat
```

此示例更适合进阶用户，在真实硬件上进行底层调试。

**Section sources**
- [test_xhci_uvc/Cargo.toml](file://test_crates/test_xhci_uvc/Cargo.toml#L0-L27)
- [test_libusb/Cargo.toml](file://test_crates/test_libusb/Cargo.toml#L0-L13)
- [test_crates/test_xhci_uvc/README.md](file://test_crates/test_xhci_uvc/README.md#L0-L7)

## 关键配置选项说明
CrabUSB 支持多后端架构，通过 Cargo 特性（features）控制功能启用。

### libusb 后端启用方式
在 `Cargo.toml` 中声明：
```toml
[target.'cfg(not(target_os = "none"))'.dependencies]
crab-usb = {workspace = true, features = ["libusb"]}
```

这表示当目标平台不是 `no_std` 环境时，启用 `libusb` 特性，允许在用户空间进行设备访问和测试。

### 核心模块功能划分
- `usb-host`：提供主机控制器抽象层，包含 xHCI 和 libusb 两种后端实现
- `usb-if`：定义通用 USB 接口标准，包括描述符解析与传输类型
- `crab-uvc`：UVC（USB Video Class）设备专用驱动模块

启用特定特性将影响编译时链接的代码路径和运行时行为。

**Section sources**
- [usb-host/src/lib.rs](file://usb-host/src/lib.rs#L0-L28)
- [usb-if/src/lib.rs](file://usb-if/src/lib.rs#L0-L8)
- [usb-host/src/backend/mod.rs](file://usb-host/src/backend/mod.rs#L0-L32)

## 设备连接与基本传输操作演示
以下是从 `test_libusb_uvc/src/main.rs` 中提取的核心流程逻辑，展示了如何使用 CrabUSB 进行设备通信。

### 步骤一：创建 USB 主机实例
```rust
let mut host = USBHost::new_libusb();
```
初始化一个基于 libusb 的主机对象，准备扫描连接的设备。

### 步骤二：启动事件处理线程
```rust
let event_handler = host.event_handler();
thread::spawn(move || {
    while event_handler.handle_event() {
        spin_loop();
    }
});
```
异步监听 USB 事件（如插拔、中断），确保实时响应设备状态变化。

### 步骤三：枚举并打开设备
```rust
let devices = host.device_list().await?;
for device_info in devices {
    if UvcDevice::check(&device_info) {
        let device = device_info.open().await?;
        let uvc = UvcDevice::new(device).await?;
        break;
    }
}
```
遍历所有连接的设备，识别出 UVC 摄像头并建立通信通道。

### 步骤四：发起视频流请求
```rust
uvc.set_format(format.clone()).await?;
let mut stream = uvc.start_streaming().await?;
```
设置视频格式并启动等时传输（Isochronous Transfer），开始接收图像帧数据。

此过程体现了 CrabUSB 对异步操作的支持，所有 I/O 调用均以 `async/.await` 形式非阻塞执行。

**Section sources**
- [test_crates/test_libusb_uvc/src/main.rs](file://test_crates/test_libusb_uvc/src/main.rs#L0-L204)

## 运行结果验证与调试建议
成功运行 `test_libusb_uvc` 后，预期输出如下日志信息：
```
INFO Starting UVC video capture example
INFO Found UVC device!
INFO Device info: ...
INFO Setting format: ...
INFO Starting video streaming...
DEBUG Received frame data of XXX bytes
INFO Capture completed. Total frames: XX, Average FPS: XX.XX
INFO Video saved as output.mp4
```

若未检测到设备，请检查：
- USB 摄像头是否正常供电并被系统识别（可通过 `lsusb` 命令验证）
- 当前用户是否有权限访问 USB 设备（考虑使用 `sudo` 或配置 udev 规则）
- `libusb` 库是否正确安装且版本兼容

对于更深入的调试，可启用 `log` crate 的详细日志级别（如 `max_level_trace`）查看底层寄存器操作。

**Section sources**
- [test_crates/test_libusb_uvc/src/main.rs](file://test_crates/test_libusb_uvc/src/main.rs#L0-L204)
- [usb-host/src/backend/libusb/mod.rs](file://usb-host/src/backend/libusb/mod.rs#L0-L64)
- [usb-host/src/backend/xhci/mod.rs](file://usb-host/src/backend/xhci/mod.rs#L0-L299)

## 后续学习资源
完成本快速入门后，建议参考以下资源进一步深入学习：

- **设计文档**：`doc/design.md` 详细阐述了 CrabUSB 的锁自由架构与 TRB 环设计原理
- **xHCI 规范实现**：阅读 `usb-host/src/backend/xhci/` 下的源码，理解 Extensible Host Controller Interface 协议细节
- **UVC 流处理机制**：研究 `usb-device/uvc/examples/simple_streaming_test.rs` 学习视频帧解析流程
- **异步执行模型**：分析 `futures` 与 `tokio` 在 `no_std` 环境中的集成方式

这些资料将帮助开发者从使用者成长为贡献者，全面掌握 CrabUSB 的核心机制。

**Section sources**
- [README.md](file://README.md#L0-L53)
- [doc/design.md](file://doc