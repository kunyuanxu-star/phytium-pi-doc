# 故障排除

<cite>
**本文档中引用的文件**  
- [fxmac.rs](file://src/fxmac.rs)
- [fxmac_dma.rs](file://src/fxmac_dma.rs)
- [fxmac_phy.rs](file://src/fxmac_phy.rs)
- [fxmac_intr.rs](file://src/fxmac_intr.rs)
- [utils.rs](file://src/utils.rs)
</cite>

## 目录
1. [驱动初始化失败](#驱动初始化失败)  
2. [无法发送数据](#无法发送数据)  
3. [无法接收数据](#无法接收数据)  
4. [网络不稳定](#网络不稳定)  
5. [通用调试建议](#通用调试建议)

## 驱动初始化失败

驱动初始化失败通常由以下两个主要原因引起：PHY未检测到或DMA内存分配失败。

### 可能原因 1：PHY未检测到
在`xmac_init`函数中，会调用`FXmacPhyInit`来初始化PHY。如果PHY未被正确识别，该函数将返回错误并记录日志。

**日志检查点**：
- 查找日志 `"Phy is not found."`，这表示在所有可能的地址（0-31）上均未检测到有效的PHY设备。
- 检查 `FXmacDetect` 函数中的日志，如 `"Phy status reg is {:#x}"` 和 `"Phy id1 reg is {:#x}, Phy id2 reg is {:#x}"`，以确认MDIO通信是否正常。

**代码审查建议**：
- 确认 `FXmacDetect` 函数的实现逻辑，特别是对 `PHY_STATUS_REG_OFFSET` 寄存器读取结果为 `0xffff` 的判断，这通常意味着总线无响应。
- 检查 `FXmacPhyRead` 函数，确保在访问PHY前检查了 `FXMAC_NWSR_MDIOIDLE_MASK` 标志位，避免在MDIO总线繁忙时进行操作。

**调试步骤**：
- 使用示波器或逻辑分析仪检查MDIO和MDC信号，确认硬件连接和时序是否正确。
- 验证PHY芯片型号（Motorcomm YT8521）的供电和复位引脚状态。
- 在 `FXmacDetect` 循环中添加更详细的日志，打印每个PHY地址的探测结果。

### 可能原因 2：DMA内存分配失败
在 `FXmacNetifBuffer::default()` 中，会调用内核接口 `dma_alloc_coherent` 来分配用于DMA描述符和数据缓冲区的连续物理内存。

**日志检查点**：
- 如果 `dma_alloc_coherent` 调用失败，可能会导致后续的 `FXmacAllocDmaPbufs` 或 `FXmacBdRingCreate` 函数出现异常，但当前代码中缺少对此类失败的显式日志记录。

**代码审查建议**：
- 审查 `FXmacNetifBuffer::default()` 的实现，确保对 `dma_alloc_coherent` 的返回值进行了充分检查，并在分配失败时记录错误日志。
- 检查 `FXmacAllocDmaPbufs` 函数，确认其在为每个pbuf分配DMA内存时处理了分配失败的情况。

**调试步骤**：
- 启用详细日志级别，观察内存分配过程。
- 检查系统是否有足够的连续物理内存可供分配。
- 验证 `dma_alloc_coherent` 内核接口的实现是否正确。

**Section sources**
- [fxmac.rs](file://src/fxmac.rs#L124-L270)
- [fxmac_dma.rs](file://src/fxmac_dma.rs#L169-L200)
- [fxmac_phy.rs](file://src/fxmac_phy.rs#L229-L230)

## 无法发送数据

无法发送数据的问题可能源于发送环满或DMA未启动。

### 可能原因 1：发送环满
当所有发送描述符（BD）都被使用且尚未被硬件释放时，发送环即为“满”状态。

**日志检查点**：
- 查找日志 `"No Enough free BDs available for the request: {}"`，这直接表明没有足够的空闲BD可用于新的发送请求。
- 在 `FXmacSgsend` 函数中，检查是否有 `"Sending packets: {}"` 日志输出，确认发送流程是否已进入。

**代码审查建议**：
- 检查 `FXmacBdRingAlloc` 函数，它负责从空闲队列中分配BD。如果 `ring_ptr.free_cnt < num_bd`，则分配失败。
- 确认 `FXmacSendHandler` 或 `FXmacProcessSentBds` 是否被正确调用以回收已使用的BD。中断处理函数 `FXmacIntrHandler` 应在收到 `FXMAC_IXR_TXCOMPL_MASK` 中断后调用这些处理程序。

**调试步骤**：
- 打印发送环 (`tx_bd_queue.bdring`) 的状态，包括 `free_cnt`, `hw_cnt`, `pre_cnt` 等计数器，以了解环的使用情况。
- 确认网卡的发送完成中断（TXCOMPL）是否被触发。如果没有，问题可能出在DMA或硬件层面。

### 可能原因 2：DMA未启动
如果DMA通道未被正确启动，即使有数据包排队也无法发送。

**日志检查点**：
- 查找 `FXmacStart` 函数中的日志，如 `"Enable TX and RX by Mask={:#x}"`，确认 `mask` 变量是否包含了 `FXMAC_IXR_TXCOMPL_MASK` 等必要的中断掩码。
- 检查 `FXmacStop` 是否被意外调用，这会导致DMA停止。

**代码审查建议**：
- 审查 `FXmacStart` 函数，确保通过写入 `FXMAC_IER_OFFSET` 寄存器使能了发送相关的中断。
- 检查 `FXmacReset` 和 `FXmacDmaReset` 函数，确认DMA控制寄存器 (`FXMAC_DMACR_OFFSET`) 的配置是否正确，特别是突发长度和缓冲区大小。

**调试步骤**：
- 使用调试工具读取网卡的DMA控制和状态寄存器，验证DMA通道是否处于运行状态。
- 检查 `instance_p.is_started` 标志位是否在 `FXmacStart` 后被正确设置为 `FT_COMPONENT_IS_STARTED`。

**Section sources**
- [fxmac.rs](file://src/fxmac.rs#L295-L331)
- [fxmac_dma.rs](file://src/fxmac_dma.rs#L536-L578)
- [fxmac_intr.rs](file://src/fxmac_intr.rs#L108-L123)

## 无法接收数据

无法接收数据的原因可能包括接收环未初始化、中断未使能或PHY链接未建立。

### 可能原因 1：接收环未初始化
接收环必须在驱动启动前正确创建和配置。

**日志检查点**：
- 查找 `FXmacInitDma` 函数中的日志，如 `"FXmacInitDma, rxringptr: {:p}"` 和 `"FXmacBdRingCreate BDs count={}, separation={}, {:#x}~{:#x}"`，确认接收环的创建过程。
- 检查 `FXmacAllocDmaPbufs` 中的日志 `"Allocate RX descriptors, 1 RxBD at a time."`，确认BD和pbuf的分配是否成功。

**代码审查建议**：
- 确认 `FXmacBdRingCreate` 和 `FXmacBdRingClone` 是否被成功调用以初始化接收环。
- 检查 `FXmacSetQueuePtr` 是否被调用，将接收环的基地址写入网卡的 `FXMAC_RXQBASE_OFFSET` 寄存器。

**调试步骤**：
- 打印 `rx_bd_queue.bdring` 的 `phys_base_addr` 并与网卡寄存器中的值进行比对。
- 验证每个BD的状态字（Status Word），确保 `FXMAC_RXBUF_NEW_MASK` 位被正确设置，表示该BD可供硬件使用。

### 可能原因 2：中断未使能
如果接收中断被屏蔽，即使有数据到达，CPU也不会收到通知。

**日志检查点**：
- 查找 `FXmacSetupIsr` 函数中的日志 `"register callback function for irq: {}"`，确认中断注册是否成功。
- 检查 `FXmacStart` 中的日志，确认中断掩码 `instance_p.mask` 包含了 `FXMAC_IXR_RXCOMPL_MASK`。

**代码审查建议**：
- 审查 `FXmacSetupIsr` 函数，确保 `dma_request_irq` 被正确调用以注册中断处理程序 `xmac_intr_handler`。
- 确认 `FXmacStart` 中通过 `FXMAC_IER_OFFSET` 寄存器使能了接收中断。

**调试步骤**：
- 检查中断控制器，确认对应IRQ号的中断计数是否在增加。
- 在 `xmac_intr_handler` 开头添加日志，确认中断处理函数是否被调用。

### 可能原因 3：PHY链接未建立
PHY必须与对端设备协商成功并建立物理链接。

**日志检查点**：
- 查找 `FXmacPhyInit` 中的日志 `"Setting phy addr is {}"`，确认PHY已被找到。
- 如果启用了自动协商，查找 `"Start phy auto negotiation."` 和 `"Auto negotiation complete."`，确认协商过程。
- 检查 `FXmacLinkChange` 函数（虽然未在提供的代码中显示）的日志，它应报告链接状态的变化。

**代码审查建议**：
- 确认 `FXmacGetIeeePhySpeed` 或 `FXmacConfigureIeeePhySpeed` 是否根据配置正确设置了PHY的速度和双工模式。
- 检查 `FXmacPhyRead` 对 `PHY_STATUS_REG_OFFSET` 寄存器的读取，其中 `PHY_STAT_LINK_STATUS` 位指示链接状态。

**调试步骤**：
- 使用命令行工具或直接读取PHY寄存器来查询链接状态。
- 检查网线和对端设备是否工作正常。

**Section sources**
- [fxmac.rs](file://src/fxmac.rs#L249-L270)
- [fxmac_dma.rs](file://src/fxmac_dma.rs#L380-L499)
- [fxmac_intr.rs](file://src/fxmac_intr.rs#L70-L72)

## 网络不稳定

网络不稳定通常由PHY协商错误或电缆问题引起。

### 可能原因 1：PHY协商错误
自动协商过程失败或协商出非预期的速率/双工模式。

**日志检查点**：
- 查找 `"Auto negotiation is error."`，这表示协商超时。
- 检查 `"Speed is 100M."` 或 `"Duplex is half."` 等日志，确认最终协商的结果是否符合预期。

**代码审查建议**：
- 审查 `FXmacGetIeeePhySpeed` 函数中的循环，其等待 `PHY_STATUS_AUTONEGOTIATE_COMPLETE` 位被置起，超时时间为 `0xff` 次迭代，每次延迟50ms。
- 确认 `FXmacPhyWrite` 在配置 `PHY_CONTROL_REG_OFFSET` 时正确设置了 `PHY_CONTROL_AUTONEGOTIATE_ENABLE` 和 `PHY_CONTROL_AUTONEGOTIATE_RESTART` 位。

**调试步骤**：
- 强制禁用自动协商，手动设置一个固定的速率和双工模式（如100M全双工），观察稳定性是否改善。
- 使用网络分析仪捕获协商过程中的FLP（快速链路脉冲）信号。

### 可能原因 2：电缆问题
物理层的电缆或连接器损坏会导致间歇性丢包。

**日志检查点**：
- 查找来自 `FXmacErrorHandler` 的错误日志，如 `"Receive over run"` (`FXMAC_RXSR_RXOVR_MASK`) 或 `"Transmit under run"` (`FXMAC_TXSR_URUN_MASK`)，这些可能与信号完整性差有关。
- `"Receive buffer not available"` 错误也可能因频繁的重传而导致。

**代码审查建议**：
- 检查 `FXmacErrorHandler` 函数，它根据方向和错误码记录不同的错误信息。
- 确认驱动是否实现了基本的错误恢复机制，例如在严重错误后重启DMA。

**调试步骤**：
- 更换网线和交换机端口进行测试。
- 检查PHY芯片的信号眼图质量（如果有相关工具）。

**Section sources**
- [fxmac_phy.rs](file://src/fxmac_phy.rs#L278-L321)
- [fxmac_intr.rs](file://src/fxmac_intr.rs#L336-L374)

## 通用调试建议

为了有效诊断和解决上述问题，请遵循以下通用建议：

1.  **启用详细日志**：在整个代码库中大量使用 `info!`, `debug!`, `warn!`, 和 `error!` 宏。在关键函数入口、条件分支和循环中添加日志，以追踪执行流程和变量状态。
2.  **检查返回值**：确保所有可能失败的函数调用（如 `FXmacPhyRead`, `FXmacPhyWrite`, `dma_alloc_coherent`）的返回值都被检查，并在失败时记录有意义的错误信息。
3.  **利用现有参考**：查阅文档中提到的Linux内核驱动 `macb_main.c`，对比其错误处理和初始化流程，获取调试思路。
4.  **联系维护者**：如果问题依然无法解决，可以联系代码作者（xiaoluoyuan@163.com）或在项目仓库中提交问题。

**Section sources**
- [fxmac.rs](file://src/fxmac.rs)
- [fxmac_dma.rs](file://src/fxmac_dma.rs)
- [fxmac_phy.rs](file://src/fxmac_phy.rs)
- [fxmac_intr.rs](file://src/fxmac_intr.rs)
- [README.md](file://README.md)