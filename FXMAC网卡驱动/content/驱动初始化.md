
# 驱动初始化

<cite>
**本文档中引用的文件**
- [fxmac.rs](file://src/fxmac.rs)
- [fxmac_phy.rs](file://src/fxmac_phy.rs)
- [fxmac_dma.rs](file://src/fxmac_dma.rs)
- [fxmac_const.rs](file://src/fxmac_const.rs)
- [fxmac_intr.rs](file://src/fxmac_intr.rs)
</cite>

## 目录
1. [初始化流程概述](#初始化流程概述)
2. [FXmacConfig结构体的角色与默认配置](#fxmacconfig结构体的角色与默认配置)
3. [硬件控制器重置与启动](#硬件控制器重置与启动)
4. [DMA子系统初始化](#dma子系统初始化)
5. [PHY设备探测与初始化](#phy设备探测与初始化)
6. [状态标志管理](#状态标志管理)
7. [初始化失败原因与调试建议](#初始化失败原因与调试建议)
8. [模块协同工作分析](#模块协同工作分析)

## 初始化流程概述

FXmac驱动的初始化从`xmac_init`函数调用开始，该函数是整个初始化过程的入口点。它接收一个MAC地址作为参数，并返回一个指向已初始化的`FXmac`实例的静态可变引用。初始化流程遵循一系列有序步骤：首先创建并配置`FXmacConfig`结构体，然后依次调用`FXmacReset`、`FXmacPhyInit`、`FXmacSelectClk`、`FXmacInitInterface`、`FXmacInitDma`和`FXmacSetupIsr`等关键函数，最终通过`FXmacStart`将设备置于就绪状态。此过程确保了主控、DMA和PHY三个核心模块被正确配置并协同工作。

**Section sources**
- [fxmac.rs](file://src/fxmac.rs#L100-L200)

## FXmacConfig结构体的角色与默认配置

`FXmacConfig`结构体在初始化过程中扮演着核心角色，它定义了网卡控制器的所有基本配置参数。当`xmac_init`被调用时，会立即构建一个`FXmacConfig`实例，其包含以下关键字段：
- `instance_id`: 设备ID，对于第一个MAC为`FXMAC0_ID`。
- `base_address`: 控制器寄存器的物理基地址，如`FXMAC0_BASE_ADDR`。
- `interface`: PHY接口模式，例如`FXMAC_PHY_INTERFACE_MODE_SGMII`。
- `speed` 和 `duplex`: 分别表示通信速度（100 Mbps）和双工模式（全双工）。
- `auto_neg`: 自动协商使能标志。
- `pclk_hz`: 外设时钟频率，如`FXMAC0_PCLK`。
- `network_default_config`: 网络功能选项的位掩码，包含了启用收发器、流控、FCS校验等默认设置。

这些默认值在代码中被硬编码，确保了驱动在没有外部干预的情况下能够以一种安全且兼容的方式启动。

**Section sources**
- [fxmac.rs](file://src/fxmac.rs#L50-L90)
- [fxmac_const.rs](file://src/fxmac_const.rs#L600-L650)

## 硬件控制器重置与启动

### FXmacReset 函数
`FXmacReset`函数负责对硬件进行彻底的软复位。它首先调用`FXmacStop`来停止所有操作，然后读取模块标识符（`moudle_id`），并根据此ID确定总线宽度。接着，它会清除网络控制寄存器（`FXMAC_NWCTRL_OFFSET`），配置网络配置寄存器（`FXMAC_NWCFG_OFFSET`）以设置正确的时钟分频和DMA位宽，并调用`FXmacDmaReset`来初始化DMA引擎。最后，它会清除所有统计计数器和中断状态，并同步`FXmacSetOptions`中的默认配置到硬件，但保持发送和接收功能处于禁用状态，直到`FXmacStart`被显式调用。

### FXmacStart 函数
`FXmacStart`函数标志着初始化的完成和设备的正式启用。它首先清除所有现存的中断状态，然后检查`network_default_config`中的`FXMAC_TRANSMITTER_ENABLE_OPTION`和`FXMAC_RECEIVER_ENABLE_OPTION`标志。如果这些标志被设置，则分别通过向`FXMAC_NWCTRL_OFFSET`寄存器写入相应的位来启用发送器和接收器。最后，它通过向`FXMAC_IER_OFFSET`寄存器写入`mask`成员变量来使能之前配置的中断（如接收完成、链路状态改变等），并将`is_started`状态标志设置为`FT_COMPONENT_IS_STARTED`，表明设备已完全启动。

**Section sources**
- [fxmac.rs](file://src/fxmac.rs#L400-L500)
- [fxmac.rs](file://src/fxmac.rs#L300-L350)

## DMA子系统初始化

DMA子系统的初始化由`FXmacInitDma`函数主导。该函数首先调用`FXmacBdRingCreate`为接收（RX）和发送（TX）队列创建环形缓冲区描述符（BD Ring）。每个BD Ring都包含一组固定数量的缓冲区描述符（由`FXMAX_RX_PBUFS_LENGTH`和`FXMAX_TX_PBUFS_LENGTH`定义），这些描述符用于跟踪DMA传输的状态和数据位置。随后，`FXmacBdRingClone`函数使用一个模板BD（其中已预设好初始状态，如发送BD的`TXBUF_USED_MASK`位）来填充整个环。最关键的一步是`FXmacAllocDmaPbufs`，它为每个RX BD分配实际的内存页（通过`dma_alloc_coherent`），并将这些物理地址写入对应的BD中。最后，`FXmacSetQueuePtr`被用来将BD Ring的物理基地址写入控制器的`RXQBASE_OFFSET`和`TXQBASE_OFFSET`寄存器，从而完成DMA通道的最终配置。

**Section sources**
- [fxmac_dma.rs](file://src/fxmac_dma.rs#L500-L700)
- [fxmac.rs](file://src/fxmac.rs#L600-L650)

## PHY设备探测与初始化

### PHY探测 (FXmacDetect)
初始化流程中，`FXmacPhyInit`函数首先调用`FXmacDetect`来探测连接的PHY设备。该函数遍历从0到31的PHY地址空间，尝试通过MDIO总线读取每个地址上的PHY状态寄存器（`PHY_STATUS_REG_OFFSET`）。如果读取成功且返回值不为`0xFFFF`（无效值），则进一步读取PHY标识符寄存器（`PHY_IDENTIFIER_1_REG`和`PHY_IDENTIFIER_2_REG`）。只有当两个标识符均非零且非全1时，才认为找到了有效的PHY，并将其地址记录在`instance_p.phy_address`中。

### PHY初始化 (FXmacPhyInit)
一旦PHY被探测到，`FXmacPhyInit`会根据`config.auto_neg`