# 寄存器详细说明

<cite>
**Referenced Files in This Document**   
- [reg.rs](file://src/reg.rs)
- [lib.rs](file://src/lib.rs)
- [chan.rs](file://src/chan.rs)
</cite>

## 目录
1. [全局寄存器](#全局寄存器)
2. [通道专用寄存器](#通道专用寄存器)
3. [寄存器交互逻辑](#寄存器交互逻辑)
4. [Rust代码与硬件寄存器映射](#rust代码与硬件寄存器映射)

## 全局寄存器

### DMA_CTL 控制寄存器 (偏移地址: 0x00)
该寄存器用于控制整个DDMA控制器的全局状态。

- **DMA_ENABLE (位 0)**: 全局使能信号。置1时启用DMA控制器，置0时禁用。
- **DMA_SRST (位 1)**: 全局软件复位信号。置1时触发软件复位，需随后清零以完成复位流程。

**Section sources**
- [reg.rs](file://src/reg.rs#L15-L28)

### DMA_STAT 状态寄存器 (偏移地址: 0x08)
该寄存器反映各通道的传输完成状态。

- **CHALx_SEL (位 x*4, x=0..7)**: 通道x的块传输完成标志。当对应通道传输完成后，该位被硬件置1；软件可通过写1来清除该标志。

**Section sources**
- [reg.rs](file://src/reg.rs#L96-L140)

### DMA_MASK_INT 中断掩码寄存器 (偏移地址: 0x0C)
该寄存器用于屏蔽或使能各通道的中断输出。

- **CHALx_MASK (位 x, x=0..7)**: 通道x的中断掩码控制。置1时屏蔽该通道的中断输出，置0时使能。
- **GLOBAL_EN (位 31)**: 全局中断使能输出控制。

**Section sources**
- [reg.rs](file://src/reg.rs#L142-L168)

### DMA_CHAL_CONFIG 通道配置寄存器 (偏移地址: 0x04)
该寄存器用于配置前四个通道（0-3）的DMA请求源选择。

- **CHALx_SEL (位 x*8 到 x*8+6, x=0..3)**: 通道x的DMA请求信号源选择（32选1）。
- **CHALx_SEL_EN (位 x*8+7, x=0..3)**: 通道x的DMA请求信号源选择使能标志。

**Section sources**
- [reg.rs](file://src/reg.rs#L30-L62)

### DMA_CHAL_CONFIG1 通道配置寄存器1 (偏移地址: 0x28)
该寄存器功能同DMA_CHAL_CONFIG，但用于配置后四个通道（4-7）。

- **CHALx_SEL (位 x*8 到 x*8+6, x=4..7)**: 通道x的DMA请求信号源选择。
- **CHALx_SEL_EN (位 x*8+7, x=4..7)**: 通道x的选择使能标志。

**Section sources**
- [reg.rs](file://src/reg.rs#L64-L94)

### DMA_CHANNEL_BIND 通道绑定寄存器 (偏移地址: 0x20)
该寄存器指示各通道是否已绑定到外设。

- **DMA_CHANNEL_BIND (位 0-7)**: 每个位对应一个通道，1表示该通道已绑定到外设DMA请求信号，0表示未绑定。

**Section sources**
- [reg.rs](file://src/reg.rs#L170-L180)

### DMA_GCAP 全局能力寄存器 (偏移地址: 0x24)
只读寄存器，指示当前DMA设计中可用的有效通道总数。

**Section sources**
- [reg.rs](file://src/reg.rs#L182-L188)

## 通道专用寄存器

每个DMA通道拥有独立的寄存器块，从基地址偏移 `0x40 + 0x40 * x` 开始，大小为64字节。

### DMA_CHALX_CTL 通道控制寄存器 (偏移地址: 0x18)
控制特定通道x的行为。

- **CHALX_EN (位 0)**: 通道使能信号。置1时通道工作，置0时通道停止但寄存器和FIFO值保持不变。
- **CHALX_SRST (位 1)**: 通道复位控制。有效时重置通道相关寄存器和FIFO，软件必须先禁用通道再进行复位。
- **CHALX_MODE (位 2)**: 通道模式选择。1表示接收外设dma_rx_req请求，0表示接收dma_tx_req请求。正常操作时不可修改，仅在通道禁用时允许操作。

**Section sources**
- [reg.rs](file://src/reg.rs#L190-L218)

### DMA_CHALX_STS 通道状态寄存器 (偏移地址: 0x1C)
反映特定通道x的运行状态。

- **FIFO_FULL (位 0)**: 对应FIFO满状态信号。
- **FIFO_EMPTY (位 1)**: 对应FIFO空状态信号。

**Section sources**
- [reg.rs](file://src/reg.rs#L220-L230)

### DMA_CHALX_TIMEOUT_CNT 通道超时计数寄存器 (偏移地址: 0x20)
配置特定通道x的超时机制。

- **TIMEOUT_CNT (位 0-29)**: 超时机制启用时的阈值时间。
- **TIMEOUT_EN (位 31)**: 超时使能信号。

**Section sources**
- [reg.rs](file://src/reg.rs#L232-L246)

## 寄存器交互逻辑

### 触发软件复位
要对整个DDMA控制器执行软件复位，需向`DMA_CTL`寄存器的`DMA_SRST`位（位1）写入1，然后立即写入0。此操作会重置控制器内部状态，但不会影响通道的配置寄存器。

**Section sources**
- [lib.rs](file://src/lib.rs#L108-L110)

### 检测通道传输完成
通过读取`DMA_STAT`寄存器中对应的`CHALx_SEL`位可以检测通道x的传输是否完成。当传输完成后，该位被硬件置1。软件处理完中断或轮询到该状态后，应向该位写1以清除状态，避免重复触发。

**Section sources**
- [lib.rs](file://src/lib.rs#L188-L204)

### 配置通道请求源
通过`set_channel_config`方法可以配置任意通道的DMA请求源。对于通道0-3，该方法修改`DMA_CHAL_CONFIG`寄存器；对于通道4-7，则修改`DMA_CHAL_CONFIG1`寄存器。配置包括选择具体的请求信号源（`sel`参数）以及是否启用该选择（`enable`参数）。

**Section sources**
- [reg.rs](file://src/reg.rs#L250-L318)

### 绑定与解绑通道
`is_channel_bind`和`set_channel_bind`方法通过读写`DMA_CHANNEL_BIND`寄存器来查询或设置通道的绑定状态。当一个通道被分配给某个外设使用时，其对应的位会被置1。

**Section sources**
- [reg.rs](file://src/reg.rs#L378-L397)

## Rust代码与硬件寄存器映射

驱动程序使用`tock-registers`库提供的`register_bitfields!`和`register_structs!`宏将硬件寄存器精确地映射到Rust类型系统中。

### 位字段定义 (`register_bitfields!`)
`register_bitfields!`宏用于定义每个寄存器的位字段布局。例如，`DMA_CTL`寄存器被定义为包含`DMA_ENABLE`和`DMA_SRST`两个位域，分别位于第0位和第1位。这使得开发者可以通过语义化的名字（如`.DMA_ENABLE::SET`）而非原始位掩码来操作寄存器，极大地提高了代码的可读性和安全性。

**Section sources**
- [reg.rs](file://src/reg.rs#L15-L246)

### 寄存器结构体定义 (`register_structs!`)
`register_structs!`宏用于定义寄存器块的内存布局。`DdmaRegister`结构体按照物理内存地址排列了所有全局寄存器，而`DmaChannelRegisters`则定义了一个通道所需的全部寄存器。这种结构化的定义确保了Rust代码中的访问与硬件的实际布局完全一致。

**Section sources**
- [reg.rs](file://src/reg.rs#L248-L318)

### 安全的寄存器访问
通过`ReadOnly<u32, Register>`和`ReadWrite<u32, Register>`等类型，`tock-registers`库提供了类型安全的寄存器访问。编译器会强制检查对只读寄存器的写入操作，并确保所有位操作都在预定义的字段范围内进行，从而防止了非法的硬件访问。

**Section sources**
- [reg.rs](file://src/reg.rs#L248-L318)