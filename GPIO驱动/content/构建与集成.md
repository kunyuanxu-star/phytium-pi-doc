# 构建与集成

<cite>
**本文档引用的文件**
- [Cargo.toml](file://Cargo.toml)
- [src/lib.rs](file://src/lib.rs)
</cite>

## 目录
1. [简介](#简介)
2. [在项目中添加依赖](#在项目中添加依赖)
3. [工具链与目标平台配置](#工具链与目标平台配置)
4. [代码集成与使用示例](#代码集成与使用示例)
5. [Feature 功能定制](#feature-功能定制)
6. [交叉编译流程](#交叉编译流程)
7. [本地构建测试](#本地构建测试)
8. [版本兼容性注意事项](#版本兼容性注意事项)

## 简介

`phytium-pi-gpio` 是一个为 Phytium Pi 平台设计的 GPIO 驱动库，采用 Rust 语言编写，专为无标准库（no-std）的嵌入式环境优化。本指南旨在指导开发者如何将此驱动库集成到自己的嵌入式 Rust 项目中，涵盖从依赖管理、工具链配置到代码集成和构建测试的完整流程。

**Section sources**
- [Cargo.toml](file://Cargo.toml#L0-L14)
- [src/lib.rs](file://src/lib.rs#L0-L3)

## 在项目中添加依赖

要将 `phytium-pi-gpio` 库作为依赖项添加到您的目标项目中，您需要修改项目的 `Cargo.toml` 文件。可以通过指定 Git 仓库地址和版本号来引入该库。

推荐的依赖添加方式如下：
```toml
[dependencies.phytium-pi-gpio]
git = "https://github.com/arceos-org/phytium-pi-gpio"
rev = "v0.1.0" # 或指定具体的 commit hash
```

此配置确保您的项目从指定的 Git 仓库拉取 `phytium-pi-gpio` 库，并锁定在 `v0.1.0` 版本，以保证构建的可重复性和稳定性。

**Section sources**
- [Cargo.toml](file://Cargo.toml#L0-L14)

## 工具链与目标平台配置

由于 `phytium-pi-gpio` 是一个 `#![no_std]` 库，它不依赖于 Rust 标准库，因此必须进行交叉编译以适配特定的嵌入式目标平台。通常，Phytium Pi 平台的目标三元组为 `aarch64-unknown-none`。

在开始构建之前，请确保已安装相应的 Rust 编译目标：
```bash
rustup target add aarch64-unknown-none
```

此命令会下载并安装针对 `aarch64-unknown-none` 架构的必要编译工具链，使 `cargo` 能够为目标硬件生成正确的二进制代码。

**Section sources**
- [src/lib.rs](file://src/lib.rs#L0)

## 代码集成与使用示例

在您的主程序中，可以通过 `extern crate` 或 `use` 语句来引入 `phytium-pi-gpio` 库。尽管当前库的实现尚处于待开发状态（TODO），但未来的公共接口调用方式预计将遵循以下模式：

```rust
// 引入 phytium-pi-gpio 库
extern crate phytium_pi_gpio;

use phytium_pi_gpio::GpioController;

fn main() {
    // 初始化 GPIO 控制器
    let mut gpio = GpioController::new();
    
    // 配置 GPIO 引脚（示例）
    // gpio.setup_pin(5, PinMode::Output);
    // gpio.set_high(5);
}
```

上述代码片段展示了未来可能的 API 使用方式，具体方法名和参数将在驱动实现完成后确定。

**Section sources**
- [src/lib.rs](file://src/lib.rs#L0-L3)

## Feature 功能定制

目前，`phytium-pi-gpio` 的 `Cargo.toml` 文件中未定义任何自定义的 feature。这意味着用户无法通过启用或禁用特定 feature 来定制构建行为。所有功能均按默认方式编译。

```toml
[dependencies]
tock-registers = { version = "0.8", default-features = false, features = ["register_types"] }
log = { version = "0.4", default-features = false }
spin = { version = "0.9", default-features = false, features = ["spin_mutex", "once"] }
```

如上所示，虽然依赖项自身启用了某些 feature（如 `spin` 的 `spin_mutex`），但主 crate 本身没有提供可选的 feature 开关。未来可根据需求扩展此功能。

**Section sources**
- [Cargo.toml](file://Cargo.toml#L10-L14)

## 交叉编译流程

将 `phytium-pi-gpio` 集成到项目后，完整的交叉编译流程如下：

1.  确保目标平台已安装：`rustup target add aarch64-unknown-none`
2.  在项目根目录下运行构建命令：
    ```bash
    cargo build --target aarch64-unknown-none
    ```
3.  Cargo 将自动解析 `phytium-pi-gpio` 及其所有依赖项，并针对 `aarch64-unknown-none` 平台进行编译。
4.  成功编译后，可在 `target/aarch64-unknown-none/debug/` 目录下找到生成的二进制文件。

**Section sources**
- [Cargo.toml](file://Cargo.toml#L0-L14)
- [src/lib.rs](file://src/lib.rs#L0)

## 本地构建测试

为了验证 `phytium-pi-gpio` 驱动库本身的构建是否成功，可以在其源码目录下直接执行本地构建测试。这有助于在提交代码前确认没有编译错误。

执行以下命令进行测试：
```bash
cd /path/to/phytium-pi-gpio
cargo build --target aarch64-unknown-none
```

如果输出显示 `Finished dev [unoptimized + debuginfo] target(s) in X.XXs`，则表明编译通过。即使当前库主体为空，只要 `#![no_std]` 属性和依赖项声明正确，即可成功编译。

**Section sources**
- [Cargo.toml](file://Cargo.toml#L0-L14)
- [src/lib.rs](file://src/lib.rs#L0)

## 版本兼容性注意事项

在集成 `phytium-pi-gpio` 时，需特别注意其依赖项的版本兼容性。该库明确指定了以下依赖版本：
- `tock-registers` v0.8
- `log` v0.4
- `spin` v0.9

您的主项目应确保这些依赖项的版本范围与之兼容，避免因版本冲突导致编译失败或运行时行为异常。建议使用 `cargo tree` 命令检查依赖树，以识别潜在的版本不一致问题。

**Section sources**
- [Cargo.toml](file://Cargo.toml#L10-L14)